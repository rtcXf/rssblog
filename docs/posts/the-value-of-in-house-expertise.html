<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>The value of in-house expertise | Rahul Vishwakarma Blog</title>
    <link rel="stylesheet" type="text/css" href="../styles.css" media="screen" />
</head>
<body>
<header>
    <nav>
        <a href="/index.html" aria-label="Go back to the homepage">← Back</a>
        <a href="https://danluu.com/in-house/" target="_blank" rel="noopener noreferrer">
            View Original
        </a>
    </nav>
</header>

<main>
    <article>
        <h1>The value of in-house expertise</h1>
        <section>
            
            <div id="readability-page-1" class="page"><div> <p>An alternate title for this post might be, &#34;Twitter has a kernel team!?&#34;. At this point, I&#39;ve heard that surprised exclamation enough that I&#39;ve lost count of the number times that&#39;s been said to me (I&#39;d guess that it&#39;s more than ten but less than a hundred). If we look at trendy companies that are within a couple factors of two in size of Twitter (in terms of either market cap or number of engineers), they mostly don&#39;t have similar expertise, often as a result of path dependence — because they &#34;grew up&#34; in the cloud, they didn&#39;t need kernel expertise to keep the lights on the way an on prem company does. While that makes it socially understandable that people who&#39;ve spent their career at younger, trendier, companies, are surprised by Twitter having a kernel team, I don&#39;t think there&#39;s a technical reason for the surprise.</p> <p>Whether or not it has kernel expertise, a company Twitter&#39;s size is going to regularly run into kernel issues, from major production incidents to papercuts. Without a kernel team or the equivalent expertise, the company will muddle through the issues, running into unnecessary problems as well as taking an unnecessarily long time to mitigate incidents. As an example of a critical production incident, just because it&#39;s already been written up publicly, I&#39;ll cite <a href="https://blog.twitter.com/engineering/en_us/topics/open-source/2020/hunting-a-linux-kernel-bug">this post</a>, which dryly notes:</p> <blockquote> <p>Earlier last year, we identified a firewall misconfiguration which accidentally dropped most network traffic. We expected resetting the firewall configuration to fix the issue, but resetting the firewall configuration exposed a kernel bug</p> </blockquote> <p>What this implies but doesn&#39;t explicitly say is that this firewall misconfiguration was the most severe incident that&#39;s occured during my time at Twitter and I believe it&#39;s actually the most severe outage that Twitter has had since 2013 or so. As a company, we would&#39;ve still been able to mitigate the issue without a kernel team or another team with deep Linux expertise, but it would&#39;ve taken longer to understand why the initial fix didn&#39;t work, which is the last thing you want when you&#39;re debugging a serious outage. Folks on the kernel team were already familiar with the various diagnostic tools and debugging techniques necessary to quickly understand why the initial fix didn&#39;t work, which is not common knowledge at some peer companies (I polled folks at a number of similar-scale peer companies to see if they thought they had at least one person with the knowledge necessary to quickly debug the bug and the answer was no at many companies).</p> <p>Another reason to have in-house expertise in various areas is that they easily pay for themselves, which is a special case of <a href="https://danluu.com/sounds-easy/">the generic argument that large companies should be larger than most people expect because tiny percentage gains are worth a large amount in absolute dollars</a>. If, in the lifetime of the specialist team like the kernel team, a single person found something that persistently reduced <a href="https://en.wikipedia.org/wiki/Total_cost_of_ownership">TCO</a> by 0.5%, that would pay for the team in perpetuity, and Twitter’s kernel team has found many such changes. In addition to <a href="https://patchwork.ozlabs.org/project/netdev/list/?submitter=211&amp;state=*&amp;archive=both&amp;param=4&amp;page=1">kernel patches</a> that sometimes have that kind of impact, people will also find configuration issues, etc., that have that kind of impact.</p> <p>So far, I&#39;ve only talked about the kernel team because that&#39;s the one that most frequently elicits surprise from folks for merely existing, but I get similar reactions when people find out that Twitter has a bunch of ex-Sun JVM folks who worked on HotSpot, like Ramki Ramakrishna, Tony Printezis, and John Coomes. People wonder why a social media company would need such deep JVM expertise. As with the kernel team, companies our size that use the JVM run into weird issues and JVM bugs and it&#39;s helpful to have people with deep expertise to debug those kinds of issues. And, as with the kernel team, individual optimizations to the JVM can pay for the team in perpetuity. A concrete example is <a href="https://github.com/oracle/graal/pull/636">this patch by Flavio Brasil, which virtualizes compare and swap calls</a>.</p> <p>The context for this is that Twitter uses a lot of Scala. Despite a lot of claims otherwise, Scala uses more memory and is significantly slower than Java, which has a significant cost if you use Scala at scale, enough that it makes sense to do optimization work to reduce the performance gap between idiomatic Scala and idiomatic Java.</p> <p>Before the patch, if you profiled our Scala code, you would&#39;ve seen an unreasonably large amount of time spent in Future/Promise, including in cases where you might naively expect that the compiler would optimize the work away. One reason for this is that Futures use a <a href="https://en.wikipedia.org/wiki/Compare-and-swap">compare-and-swap</a> (CAS) operation that&#39;s opaque to JVM optimization. The patch linked above avoids CAS operations when the Future doesn&#39;t escape the scope of the method. <a href="https://github.com/twitter/util/commit/3245a8e1a98bd5eb308f366678528879d7140f5e">This companion patch</a> removes CAS operations in some places that are less amenable to compiler optimization. The two patches combined reduced the cost of typical major Twitter services using idiomatic Scala by 5% to 15%, paying for the JVM team in perpetuity many times over and that wasn&#39;t even the biggest win Flavio found that year.</p> <p>I&#39;m not going to do a team-by-team breakdown of teams that pay for themselves many times over because there are so many of them, even if I limit the scope to &#34;teams that people are surprised that Twitter has&#34;.</p> <p>A related topic is how people talk about &#34;buy vs. build&#34; discussions. I&#39;ve seen a number of discussions where someone has argued for &#34;buy&#34; because that would obviate the need for expertise in the area. This can be true, but I&#39;ve seen this argued for much more often than it is true. An example where I think this tends to be untrue is with distributed tracing. <a href="https://danluu.com/tracing-analytics/">We&#39;ve previously looked at some ways Twitter gets value out of tracing</a>, which came out of the vision Rebecca Isaacs put into place. On the flip side, when I talk to people at peer companies with similar scale, most of them have not (yet?) succeeded at getting significant value from distributed tracing. This is so common that I see a viral Twitter thread about how useless distributed tracing is more than once a year. Even though we went with the more expensive &#34;build&#34; option, just off the top of my head, I can think of multiple uses of tracing that have returned between 10x and 100x the cost of building out tracing, whereas people at a number of companies that have chosen the cheaper &#34;buy&#34; option commonly complain that tracing isn&#39;t worth it.</p> <p>Coincidentally, I was just talking about this exact topic to Pam Wolf, a civil engineering professor with experience in (civil engineering) industry on multiple continents, who had a related opinion. For large scale systems (projects), you need an in-house expert (owner&#39;s-side engineer) for each area that you don&#39;t handle in your own firm. While it&#39;s technically possible to hire yet another firm to be the expert, that&#39;s more expensive than developing or hiring in-house expertise and, in the long run, also more risky. That&#39;s pretty analogous to my experience working as an electrical engineer as well, where orgs that outsource functions to other companies without retaining an in-house expert pay a very high cost, and not just monetarily. They often ship sub-par designs with long delays on top of having high costs. &#34;Buying&#34; can and often does reduce the amount of expertise necessary, but it often doesn&#39;t remove the need for expertise.</p> <p>This related to another common abstract argument that&#39;s commonly made, that companies should concentrate on &#34;their area of comparative advantage&#34; or &#34;most important problems&#34; or &#34;core business need&#34; and outsource everything else. We&#39;ve already seen a couple of examples where this isn&#39;t true because, at a large enough scale, it&#39;s more profitable to have in-house expertise than not regardless of whether or not something is core to the business (one could argue that all of the things that are moved in-house are core to the business, but that would make the concept of coreness useless). Another reason this abstract advice is too simplistic is that businesses can somewhat arbitrarily choose what their comparative advantage is. A large example of this would be Apple bringing CPU design in-house. Since acquiring PA Semi (formerly the team from SiByte and, before that, a team from DEC) for $278M, Apple has been producing <a href="https://twitter.com/danluu/status/1433297089866383364">the best chips in the phone and laptop power envelope by a pretty large margin</a>. But, before the purchase, there was nothing about Apple that made the purchase inevitable, that made CPU design an inherent comparative advantage of Apple. But if a firm can pick an area and make it an area of comparative advantage, saying that the firm should choose to concentrate on its comparative advantage(s) isn&#39;t very helpful advice.</p> <p>$278M is a lot of money in absolute terms, but as a fraction of Apple&#39;s resources, that was tiny and much smaller companies also have the capability to do cutting edge work by devoting a small fraction of their resources to it, e.g., Twitter, for a cost that any $100M company could afford, <a href="https://twitter.com/danluu/status/1381687511362138113">created novel cache algorithms and data structures</a> and is doing other cutting edge cache work. Having great <a href="https://danluu.com/cache-incidents/">cache infra</a> isn&#39;t any more core to Twitter&#39;s business than creating a great CPU is to Apple&#39;s, but it is a lever that Twitter can use to make more money than it could otherwise.</p> <p>For small companies, it doesn&#39;t make sense to have in-house experts for everything the company touches, but companies don&#39;t have to get all that large before it starts making sense to have in-house expertise in their operating system, language runtime, and other components that people often think of as being fairly specialized. Looking back at Twitter&#39;s history, Yao Yue has noted that when she was working on cache in Twitter&#39;s early days (when we had ~100 engineers), she would regularly go to the kernel team for help debugging production incidents and that, in some cases, debugging could&#39;ve easily taken 10x longer without help from the kernel team. Social media companies tend to have relatively high scale on a per-user and per-dollar basis, so not every company is going to need the same kind of expertise when they have 100 engineers, but there are going to be other areas that aren&#39;t obviously core business needs where expertise will pay off even for a startup that has 100 engineers.</p> <p>Thanks to Ben Kuhn, Yao Yue, Pam Wolf, John Hergenroeder, Julien Kirch, Tom Brearley, and Kevin Burke for comments/corrections/discussion.</p>  </div></div>
        </section>
    </article>
</main>
</body>
</html>
