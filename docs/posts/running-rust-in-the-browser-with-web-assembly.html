<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Running Rust in the Browser with Web Assembly | Rahul Vishwakarma Blog</title>
    <link rel="stylesheet" type="text/css" href="../styles.css" media="screen" />
</head>
<body>
<header>
    <nav>
        <a href="/index.html" aria-label="Go back to the homepage">‚Üê Back</a>
        <a href="https://blog.boot.dev/rust/rust-in-the-browser/" target="_blank" rel="noopener noreferrer">
            View Original
        </a>
    </nav>
</header>

<main>
    <article>
        <h1>Running Rust in the Browser with Web Assembly</h1>
        <section>
            
            <div id="readability-page-1" class="page"><div>
           <p>I‚Äôve recently been working on getting Rust support in the <a href="https://www.boot.dev/">boot.dev app</a>. To write a more engaging course, I want students to be able to write and execute code right in the browser. As I‚Äôve learned from my previous posts on this topic, the easiest way to sandbox code execution on a server is to <em>not</em> execute code on a server. Enter Web Assembly, stage left.</p>
<h2 id="deprecation-disclaimer">
  <span> Deprecation Disclaimer!</span> <a href="#deprecation-disclaimer">üîó</a></h2>
<p>This recently stopped working due to the <code>io::set_print</code> function being completely deprecated. I‚Äôm leaving the post up for historical knowledge‚Äôs sake, but this won‚Äôt work anymore!</p>
<h2 id="how-it-works">
  <span> How It Works</span> <a href="#how-it-works">üîó</a></h2>
<p>The architecture is fairly simple:</p>
<ul>
<li>User writes code in the browser</li>
<li>Browser sends code to server</li>
<li>Server adds some glue and compiles code to WASM</li>
<li>Server sends WASM bytes or compiler errors back to browser</li>
<li>Browser runs WASM and displays console output, or shows compiler errors</li>
</ul>
<p>Writing code and shipping it to the server hopefully needs no explanation, it‚Äôs a simple text editor coupled with the fetch API. The first interesting thing we do is compile the code on the server.</p>
<h2 id="compiling-the-code">
  <span> Compiling the Code</span> <a href="#compiling-the-code">üîó</a></h2>
<p>Boot.dev‚Äôs server is written in Go. I have a simple HTTP handler with the following signature:</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>(</span><span>cfg</span> <span>config</span><span>)</span> <span>compileRustHandler</span><span>(</span><span>w</span> <span>http</span><span>.</span><span>ResponseWriter</span><span>,</span> <span>r</span> <span>*</span><span>http</span><span>.</span><span>Request</span><span>)</span>
</span></span></code></pre></div><p>At the start of the function we unmarshal the code which was provided in a JSON body:</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>type</span> <span>parameters</span> <span>struct</span> <span>{</span>
</span></span><span><span>	<span>Code</span> <span>string</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>decoder</span> <span>:=</span> <span>json</span><span>.</span><span>NewDecoder</span><span>(</span><span>r</span><span>.</span><span>Body</span><span>)</span>
</span></span><span><span><span>params</span> <span>:=</span> <span>parameters</span><span>{}</span>
</span></span><span><span><span>err</span> <span>:=</span> <span>decoder</span><span>.</span><span>Decode</span><span>(</span><span>&amp;</span><span>params</span><span>)</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>500</span><span>,</span> <span>&#34;Couldn&#39;t decode parameters&#34;</span><span>)</span>
</span></span><span><span>	<span>return</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Next, we create a temporary folder on disk that we‚Äôll use as a ‚Äúscratch pad‚Äù to create a Rust project.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>usr</span><span>,</span> <span>err</span> <span>:=</span> <span>user</span><span>.</span><span>Current</span><span>()</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>500</span><span>,</span> <span>&#34;Couldn&#39;t get system user&#34;</span><span>)</span>
</span></span><span><span>	<span>return</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>workingDir</span> <span>:=</span> <span>filepath</span><span>.</span><span>Join</span><span>(</span><span>usr</span><span>.</span><span>HomeDir</span><span>,</span> <span>&#34;.wasm&#34;</span><span>,</span> <span>uuid</span><span>.</span><span>New</span><span>().</span><span>String</span><span>())</span>
</span></span><span><span><span>err</span> <span>=</span> <span>os</span><span>.</span><span>MkdirAll</span><span>(</span><span>workingDir</span><span>,</span> <span>os</span><span>.</span><span>ModePerm</span><span>)</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>500</span><span>,</span> <span>&#34;Couldn&#39;t create directory for compilation&#34;</span><span>)</span>
</span></span><span><span>	<span>return</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>defer</span> <span>func</span><span>()</span> <span>{</span>
</span></span><span><span>	<span>err</span> <span>=</span> <span>os</span><span>.</span><span>RemoveAll</span><span>(</span><span>workingDir</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>500</span><span>,</span> <span>&#34;Couldn&#39;t clean up code from compilation&#34;</span><span>)</span>
</span></span><span><span>		<span>return</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span><span>}()</span>
</span></span></code></pre></div><p>As you can see, we create the project under the <code>.wasm/uuid</code> path in the home directory. We also <code>defer</code> an <code>os.RemoveAll</code> function that will delete this folder when we are doing handling this request.</p>
<p>Next we setup a helper function that will run an operating system command and return the stderr, if it exists:</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>runCmd</span><span>(</span><span>workingDir</span><span>,</span> <span>name</span> <span>string</span><span>,</span> <span>args</span> <span>...</span><span>string</span><span>)</span> <span>error</span> <span>{</span>
</span></span><span><span>	<span>cmd</span> <span>:=</span> <span>exec</span><span>.</span><span>Command</span><span>(</span><span>name</span><span>,</span> <span>args</span><span>...</span><span>)</span>
</span></span><span><span>	<span>cmd</span><span>.</span><span>Dir</span> <span>=</span> <span>filepath</span><span>.</span><span>Join</span><span>(</span><span>workingDir</span><span>)</span>
</span></span><span><span>	<span>stdErrReader</span><span>,</span> <span>err</span> <span>:=</span> <span>cmd</span><span>.</span><span>StderrPipe</span><span>()</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>return</span> <span>err</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>:=</span> <span>cmd</span><span>.</span><span>Start</span><span>();</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>return</span> <span>err</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>stdErr</span><span>,</span> <span>err</span> <span>:=</span> <span>ioutil</span><span>.</span><span>ReadAll</span><span>(</span><span>stdErrReader</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>return</span> <span>err</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>:=</span> <span>cmd</span><span>.</span><span>Wait</span><span>();</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>if</span> <span>len</span><span>(</span><span>stdErr</span><span>)</span> <span>&gt;</span> <span>0</span> <span>{</span>
</span></span><span><span>			<span>return</span> <span>fmt</span><span>.</span><span>Errorf</span><span>(</span><span>&#34;%s&#34;</span><span>,</span> <span>stdErr</span><span>)</span>
</span></span><span><span>		<span>}</span>
</span></span><span><span>		<span>return</span> <span>err</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>return</span> <span>nil</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Next, (back in the HTTP handler) we use that function to create a new Rust project in our temporary directory:</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>const</span> <span>projectName</span> <span>=</span> <span>&#34;main&#34;</span>
</span></span><span><span><span>err</span> <span>=</span> <span>runCmd</span><span>(</span><span>workingDir</span><span>,</span> <span>&#34;cargo&#34;</span><span>,</span> <span>&#34;new&#34;</span><span>,</span> <span>projectName</span><span>)</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>500</span><span>,</span> <span>err</span><span>.</span><span>Error</span><span>())</span>
</span></span><span><span>	<span>return</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>After that, we need to write the code we were given to disk. Before we do that, however, we need to add some glue. The glue code will override Rust‚Äôs print macros so that we can provide JavaScript functions that will capture stdout. I thank <a href="https://github.com/DeMille">Sterling Demille</a> for open sourcing this glue:</p>
<div><pre tabindex="0"><code data-lang="rust"><span><span><span>// copied from https://github.com/DeMille/wasm-glue
</span></span></span><span><span><span></span><span>#![feature(set_stdio)]</span><span>
</span></span></span><span><span><span></span><span>#![feature(panic_col)]</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>use</span><span> </span><span>std</span>::<span>ffi</span>::<span>CString</span><span>;</span><span>
</span></span></span><span><span><span></span><span>use</span><span> </span><span>std</span>::<span>os</span>::<span>raw</span>::<span>c_char</span><span>;</span><span>
</span></span></span><span><span><span></span><span>use</span><span> </span><span>std</span>::<span>fmt</span><span>;</span><span>
</span></span></span><span><span><span></span><span>use</span><span> </span><span>std</span>::<span>fmt</span>::<span>Write</span><span>;</span><span>
</span></span></span><span><span><span></span><span>use</span><span> </span><span>std</span>::<span>panic</span><span>;</span><span>
</span></span></span><span><span><span></span><span>use</span><span> </span><span>std</span>::<span>io</span><span>;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>// these are the functions you&#39;ll need to privide with JS
</span></span></span><span><span><span></span><span>extern</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>fn</span> <span>print</span><span>(</span><span>ptr</span>: <span>*</span><span>const</span><span> </span><span>c_char</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>fn</span> <span>eprint</span><span>(</span><span>ptr</span>: <span>*</span><span>const</span><span> </span><span>c_char</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>fn</span> <span>trace</span><span>(</span><span>ptr</span>: <span>*</span><span>const</span><span> </span><span>c_char</span><span>);</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>fn</span> <span>_print</span><span>(</span><span>buf</span>: <span>&amp;</span><span>str</span><span>)</span><span> </span>-&gt; <span>io</span>::<span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>cstring</span><span> </span><span>=</span><span> </span><span>CString</span>::<span>new</span><span>(</span><span>buf</span><span>)</span><span>?</span><span>;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>unsafe</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>print</span><span>(</span><span>cstring</span><span>.</span><span>as_ptr</span><span>());</span><span>
</span></span></span><span><span><span>    </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>Ok</span><span>(())</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>fn</span> <span>_eprint</span><span>(</span><span>buf</span>: <span>&amp;</span><span>str</span><span>)</span><span> </span>-&gt; <span>io</span>::<span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>cstring</span><span> </span><span>=</span><span> </span><span>CString</span>::<span>new</span><span>(</span><span>buf</span><span>)</span><span>?</span><span>;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>unsafe</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>eprint</span><span>(</span><span>cstring</span><span>.</span><span>as_ptr</span><span>());</span><span>
</span></span></span><span><span><span>    </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>Ok</span><span>(())</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Used by the &#34;print&#34; macro
</span></span></span><span><span><span></span><span>#[doc(hidden)]</span><span>
</span></span></span><span><span><span></span><span>pub</span><span> </span><span>fn</span> <span>_print_args</span><span>(</span><span>args</span>: <span>fmt</span>::<span>Arguments</span><span>)</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>mut</span><span> </span><span>buf</span><span> </span><span>=</span><span> </span><span>String</span>::<span>new</span><span>();</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>_</span><span> </span><span>=</span><span> </span><span>buf</span><span>.</span><span>write_fmt</span><span>(</span><span>args</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>_</span><span> </span><span>=</span><span> </span><span>_print</span><span>(</span><span>&amp;</span><span>buf</span><span>);</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Used by the &#34;eprint&#34; macro
</span></span></span><span><span><span></span><span>#[doc(hidden)]</span><span>
</span></span></span><span><span><span></span><span>pub</span><span> </span><span>fn</span> <span>_eprint_args</span><span>(</span><span>args</span>: <span>fmt</span>::<span>Arguments</span><span>)</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>mut</span><span> </span><span>buf</span><span> </span><span>=</span><span> </span><span>String</span>::<span>new</span><span>();</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>_</span><span> </span><span>=</span><span> </span><span>buf</span><span>.</span><span>write_fmt</span><span>(</span><span>args</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>_</span><span> </span><span>=</span><span> </span><span>_eprint</span><span>(</span><span>&amp;</span><span>buf</span><span>);</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Overrides the default &#34;print!&#34; macro.
</span></span></span><span><span><span></span><span>#[macro_export]</span><span>
</span></span></span><span><span><span></span><span>macro_rules</span><span>!</span><span> </span><span>print</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>(</span><span>$($arg</span>:<span>tt</span><span>)</span><span>*</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>(</span><span>$crate</span>::<span>_print_args</span><span>(</span><span>format_args!</span><span>(</span><span>$($arg</span><span>)</span><span>*</span><span>)));</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Overrides the default &#34;eprint!&#34; macro.
</span></span></span><span><span><span></span><span>#[macro_export]</span><span>
</span></span></span><span><span><span></span><span>macro_rules</span><span>!</span><span> </span><span>eprint</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>(</span><span>$($arg</span>:<span>tt</span><span>)</span><span>*</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>(</span><span>$crate</span>::<span>_eprint_args</span><span>(</span><span>format_args!</span><span>(</span><span>$($arg</span><span>)</span><span>*</span><span>)));</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>type</span> <span>PrintFn</span><span> </span><span>=</span><span> </span><span>fn</span><span>(</span><span>&amp;</span><span>str</span><span>)</span><span> </span>-&gt; <span>io</span>::<span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span><span>;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>struct</span> <span>Printer</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>printfn</span>: <span>PrintFn</span><span>,</span><span>
</span></span></span><span><span><span>    </span><span>buffer</span>: <span>String</span><span>,</span><span>
</span></span></span><span><span><span>    </span><span>is_buffered</span>: <span>bool</span><span>,</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>impl</span><span> </span><span>Printer</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>fn</span> <span>new</span><span>(</span><span>printfn</span>: <span>PrintFn</span><span>,</span><span> </span><span>is_buffered</span>: <span>bool</span><span>)</span><span> </span>-&gt; <span>Printer</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>Printer</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>buffer</span>: <span>String</span>::<span>new</span><span>(),</span><span>
</span></span></span><span><span><span>            </span><span>printfn</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>is_buffered</span><span>,</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>    </span><span>}</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>impl</span><span> </span><span>io</span>::<span>Write</span><span> </span><span>for</span><span> </span><span>Printer</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>fn</span> <span>write</span><span>(</span><span>&amp;</span><span>mut</span><span> </span><span>self</span><span>,</span><span> </span><span>buf</span>: <span>&amp;</span><span>[</span><span>u8</span><span>])</span><span> </span>-&gt; <span>io</span>::<span>Result</span><span>&lt;</span><span>usize</span><span>&gt;</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>self</span><span>.</span><span>buffer</span><span>.</span><span>push_str</span><span>(</span><span>&amp;</span><span>String</span>::<span>from_utf8_lossy</span><span>(</span><span>buf</span><span>));</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>if</span><span> </span><span>!</span><span>self</span><span>.</span><span>is_buffered</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>(</span><span>self</span><span>.</span><span>printfn</span><span>)(</span><span>&amp;</span><span>self</span><span>.</span><span>buffer</span><span>)</span><span>?</span><span>;</span><span>
</span></span></span><span><span><span>            </span><span>self</span><span>.</span><span>buffer</span><span>.</span><span>clear</span><span>();</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>            </span><span>return</span><span> </span><span>Ok</span><span>(</span><span>buf</span><span>.</span><span>len</span><span>());</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>if</span><span> </span><span>let</span><span> </span><span>Some</span><span>(</span><span>i</span><span>)</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>buffer</span><span>.</span><span>rfind</span><span>(</span><span>&#39;\n&#39;</span><span>)</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>let</span><span> </span><span>buffered</span><span> </span><span>=</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                </span><span>let</span><span> </span><span>(</span><span>first</span><span>,</span><span> </span><span>last</span><span>)</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>buffer</span><span>.</span><span>split_at</span><span>(</span><span>i</span><span>);</span><span>
</span></span></span><span><span><span>                </span><span>(</span><span>self</span><span>.</span><span>printfn</span><span>)(</span><span>first</span><span>)</span><span>?</span><span>;</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>                </span><span>String</span>::<span>from</span><span>(</span><span>&amp;</span><span>last</span><span>[</span><span>1</span><span>..</span><span>])</span><span>
</span></span></span><span><span><span>            </span><span>};</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>            </span><span>self</span><span>.</span><span>buffer</span><span>.</span><span>clear</span><span>();</span><span>
</span></span></span><span><span><span>            </span><span>self</span><span>.</span><span>buffer</span><span>.</span><span>push_str</span><span>(</span><span>&amp;</span><span>buffered</span><span>);</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>Ok</span><span>(</span><span>buf</span><span>.</span><span>len</span><span>())</span><span>
</span></span></span><span><span><span>    </span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>    </span><span>fn</span> <span>flush</span><span>(</span><span>&amp;</span><span>mut</span><span> </span><span>self</span><span>)</span><span> </span>-&gt; <span>io</span>::<span>Result</span><span>&lt;</span><span>()</span><span>&gt;</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>(</span><span>self</span><span>.</span><span>printfn</span><span>)(</span><span>&amp;</span><span>self</span><span>.</span><span>buffer</span><span>)</span><span>?</span><span>;</span><span>
</span></span></span><span><span><span>        </span><span>self</span><span>.</span><span>buffer</span><span>.</span><span>clear</span><span>();</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>Ok</span><span>(())</span><span>
</span></span></span><span><span><span>    </span><span>}</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Sets a line-buffered stdout, uses your JavaScript &#34;print&#34; function
</span></span></span><span><span><span></span><span>pub</span><span> </span><span>fn</span> <span>set_stdout</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>printer</span><span> </span><span>=</span><span> </span><span>Printer</span>::<span>new</span><span>(</span><span>_print</span><span>,</span><span> </span><span>true</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>io</span>::<span>set_print</span><span>(</span><span>Some</span><span>(</span><span>Box</span>::<span>new</span><span>(</span><span>printer</span><span>)));</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Sets an unbuffered stdout, uses your JavaScript &#34;print&#34; function
</span></span></span><span><span><span></span><span>pub</span><span> </span><span>fn</span> <span>set_stdout_unbuffered</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>printer</span><span> </span><span>=</span><span> </span><span>Printer</span>::<span>new</span><span>(</span><span>_print</span><span>,</span><span> </span><span>false</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>io</span>::<span>set_print</span><span>(</span><span>Some</span><span>(</span><span>Box</span>::<span>new</span><span>(</span><span>printer</span><span>)));</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Sets a line-buffered stderr, uses your JavaScript &#34;eprint&#34; function
</span></span></span><span><span><span></span><span>pub</span><span> </span><span>fn</span> <span>set_stderr</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>eprinter</span><span> </span><span>=</span><span> </span><span>Printer</span>::<span>new</span><span>(</span><span>_eprint</span><span>,</span><span> </span><span>true</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>io</span>::<span>set_panic</span><span>(</span><span>Some</span><span>(</span><span>Box</span>::<span>new</span><span>(</span><span>eprinter</span><span>)));</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Sets an unbuffered stderr, uses your JavaScript &#34;eprint&#34; function
</span></span></span><span><span><span></span><span>pub</span><span> </span><span>fn</span> <span>set_stderr_unbuffered</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>let</span><span> </span><span>eprinter</span><span> </span><span>=</span><span> </span><span>Printer</span>::<span>new</span><span>(</span><span>_eprint</span><span>,</span><span> </span><span>false</span><span>);</span><span>
</span></span></span><span><span><span>    </span><span>io</span>::<span>set_panic</span><span>(</span><span>Some</span><span>(</span><span>Box</span>::<span>new</span><span>(</span><span>eprinter</span><span>)));</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Sets a custom panic hook, uses your JavaScript &#34;trace&#34; function
</span></span></span><span><span><span></span><span>pub</span><span> </span><span>fn</span> <span>set_panic_hook</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>panic</span>::<span>set_hook</span><span>(</span><span>Box</span>::<span>new</span><span>(</span><span>|</span><span>info</span><span>|</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>file</span><span> </span><span>=</span><span> </span><span>info</span><span>.</span><span>location</span><span>().</span><span>unwrap</span><span>().</span><span>file</span><span>();</span><span>
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>line</span><span> </span><span>=</span><span> </span><span>info</span><span>.</span><span>location</span><span>().</span><span>unwrap</span><span>().</span><span>line</span><span>();</span><span>
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>col</span><span> </span><span>=</span><span> </span><span>info</span><span>.</span><span>location</span><span>().</span><span>unwrap</span><span>().</span><span>column</span><span>();</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>msg</span><span> </span><span>=</span><span> </span><span>match</span><span> </span><span>info</span><span>.</span><span>payload</span><span>().</span><span>downcast_ref</span>::<span>&lt;&amp;</span><span>&#39;static</span><span> </span><span>str</span><span>&gt;</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>Some</span><span>(</span><span>s</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>*</span><span>s</span><span>,</span><span>
</span></span></span><span><span><span>            </span><span>None</span><span> </span><span>=&gt;</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                </span><span>match</span><span> </span><span>info</span><span>.</span><span>payload</span><span>().</span><span>downcast_ref</span>::<span>&lt;</span><span>String</span><span>&gt;</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>                    </span><span>Some</span><span>(</span><span>s</span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>&amp;</span><span>s</span><span>[</span><span>..</span><span>],</span><span>
</span></span></span><span><span><span>                    </span><span>None</span><span> </span><span>=&gt;</span><span> </span><span>&#34;Box&lt;Any&gt;&#34;</span><span>,</span><span>
</span></span></span><span><span><span>                </span><span>}</span><span>
</span></span></span><span><span><span>            </span><span>}</span><span>
</span></span></span><span><span><span>        </span><span>};</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>err_info</span><span> </span><span>=</span><span> </span><span>format!</span><span>(</span><span>&#34;Panicked at &#39;</span><span>{}</span><span>&#39;, </span><span>{}</span><span>:</span><span>{}</span><span>:</span><span>{}</span><span>&#34;</span><span>,</span><span> </span><span>msg</span><span>,</span><span> </span><span>file</span><span>,</span><span> </span><span>line</span><span>,</span><span> </span><span>col</span><span>);</span><span>
</span></span></span><span><span><span>        </span><span>let</span><span> </span><span>cstring</span><span> </span><span>=</span><span> </span><span>CString</span>::<span>new</span><span>(</span><span>err_info</span><span>).</span><span>unwrap</span><span>();</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span>        </span><span>unsafe</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>            </span><span>trace</span><span>(</span><span>cstring</span><span>.</span><span>as_ptr</span><span>());</span><span>
</span></span></span><span><span><span>        </span><span>}</span><span>
</span></span></span><span><span><span>    </span><span>}));</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span><span><span><span>
</span></span></span><span><span><span></span><span>/// Sets stdout, stderr, and a custom panic hook
</span></span></span><span><span><span></span><span>pub</span><span> </span><span>fn</span> <span>hook</span><span>()</span><span> </span><span>{</span><span>
</span></span></span><span><span><span>    </span><span>set_stdout</span><span>();</span><span>
</span></span></span><span><span><span>    </span><span>set_stderr</span><span>();</span><span>
</span></span></span><span><span><span>    </span><span>set_panic_hook</span><span>();</span><span>
</span></span></span><span><span><span></span><span>}</span><span>
</span></span></span></code></pre></div><p>All we need to do is concatenate that glue code to the user provided code, and call <code>hook()</code> as the first thing in <code>main()</code>.</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>writeRustToDisk</span><span>(</span><span>workingDir</span><span>,</span> <span>projectName</span><span>,</span> <span>code</span> <span>string</span><span>)</span> <span>error</span> <span>{</span>
</span></span><span><span>	<span>// remove old code
</span></span></span><span><span><span></span>	<span>codePath</span> <span>:=</span> <span>filepath</span><span>.</span><span>Join</span><span>(</span><span>workingDir</span><span>,</span> <span>projectName</span><span>,</span> <span>&#34;src&#34;</span><span>,</span> <span>&#34;main.rs&#34;</span><span>)</span>
</span></span><span><span>	<span>os</span><span>.</span><span>Remove</span><span>(</span><span>codePath</span><span>)</span>
</span></span><span><span>
</span></span><span><span>	<span>// create the new file
</span></span></span><span><span><span></span>	<span>f</span><span>,</span> <span>err</span> <span>:=</span> <span>os</span><span>.</span><span>Create</span><span>(</span><span>codePath</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>return</span> <span>errors</span><span>.</span><span>New</span><span>(</span><span>&#34;Couldn&#39;t open code file for compilation&#34;</span><span>)</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>defer</span> <span>f</span><span>.</span><span>Close</span><span>()</span>
</span></span><span><span>
</span></span><span><span>	<span>// write the glue
</span></span></span><span><span><span></span>	<span>_</span><span>,</span> <span>err</span> <span>=</span> <span>f</span><span>.</span><span>WriteString</span><span>(</span><span>rustGlue</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>return</span> <span>errors</span><span>.</span><span>New</span><span>(</span><span>&#34;Couldn&#39;t write code to file for compilation&#34;</span><span>)</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>
</span></span><span><span>	<span>// add the hook
</span></span></span><span><span><span></span>	<span>code</span> <span>=</span> <span>addHook</span><span>(</span><span>code</span><span>)</span>
</span></span><span><span>
</span></span><span><span>	<span>// write the rest of the code
</span></span></span><span><span><span></span>	<span>dat</span> <span>:=</span> <span>[]</span><span>byte</span><span>(</span><span>code</span><span>)</span>
</span></span><span><span>	<span>_</span><span>,</span> <span>err</span> <span>=</span> <span>f</span><span>.</span><span>Write</span><span>(</span><span>dat</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>		<span>return</span> <span>errors</span><span>.</span><span>New</span><span>(</span><span>&#34;Couldn&#39;t write code to file for compilation&#34;</span><span>)</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>return</span> <span>nil</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Where <code>rustGlue</code> is just a string constant containing the glue from the previous step, and <code>addHook</code> is a function that uses a regex to insert the <code>hook()</code> call properly:</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>func</span> <span>addHook</span><span>(</span><span>code</span> <span>string</span><span>)</span> <span>string</span> <span>{</span>
</span></span><span><span>	<span>regex</span> <span>:=</span> <span>regexp</span><span>.</span><span>MustCompile</span><span>(</span><span>`(fn\s*main\(\)\s*)\{`</span><span>)</span>
</span></span><span><span>	<span>return</span> <span>regex</span><span>.</span><span>ReplaceAllString</span><span>(</span><span>code</span><span>,</span> <span>`fn main(){hook();`</span><span>)</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Next, the all-important compilation step:</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>err</span> <span>=</span> <span>runCmd</span><span>(</span>
</span></span><span><span>	<span>filepath</span><span>.</span><span>Join</span><span>(</span><span>workingDir</span><span>,</span> <span>projectName</span><span>),</span>
</span></span><span><span>	<span>&#34;cargo&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;+nightly&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;build&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;--target&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;wasm32-unknown-unknown&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;--release&#34;</span><span>,</span>
</span></span><span><span><span>)</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>errString</span> <span>:=</span> <span>err</span><span>.</span><span>Error</span><span>()</span>
</span></span><span><span>	<span>fmt</span><span>.</span><span>Println</span><span>(</span><span>errString</span><span>)</span>
</span></span><span><span>	<span>parts</span> <span>:=</span> <span>strings</span><span>.</span><span>Split</span><span>(</span><span>errString</span><span>,</span> <span>workingDir</span><span>)</span>
</span></span><span><span>	<span>if</span> <span>len</span><span>(</span><span>parts</span><span>)</span> <span>&lt;</span> <span>2</span> <span>{</span>
</span></span><span><span>		<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>500</span><span>,</span> <span>errString</span><span>)</span>
</span></span><span><span>		<span>return</span>
</span></span><span><span>	<span>}</span>
</span></span><span><span>	<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>400</span><span>,</span> <span>parts</span><span>[</span><span>1</span><span>])</span>
</span></span><span><span>	<span>return</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>A simple <code>cargo build</code> with <code>WASM</code> as the target. If there is an error, we strip out some of the filesystem information before sending it back to the frontend.</p>
<p>We use <code>[wasm-gc](https://lib.rs/crates/wasm-gc)</code> to optimize the build:</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>err</span> <span>=</span> <span>runCmd</span><span>(</span>
</span></span><span><span>	<span>filepath</span><span>.</span><span>Join</span><span>(</span><span>workingDir</span><span>,</span> <span>projectName</span><span>),</span>
</span></span><span><span>	<span>&#34;wasm-gc&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;target&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;wasm32-unknown-unknown&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;release&#34;</span><span>,</span>
</span></span><span><span>	<span>&#34;main.wasm&#34;</span><span>,</span>
</span></span><span><span><span>)</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>500</span><span>,</span> <span>err</span><span>.</span><span>Error</span><span>())</span>
</span></span><span><span>	<span>return</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>Finally we send the WASM back to the frontend as raw bytes:</p>
<div><pre tabindex="0"><code data-lang="go"><span><span><span>dat</span><span>,</span> <span>err</span> <span>:=</span> <span>ioutil</span><span>.</span><span>ReadFile</span><span>(</span><span>filepath</span><span>.</span><span>Join</span><span>(</span><span>workingDir</span><span>,</span> <span>projectName</span><span>,</span> <span>&#34;target&#34;</span><span>,</span> <span>&#34;wasm32-unknown-unknown&#34;</span><span>,</span> <span>&#34;release&#34;</span><span>,</span> <span>&#34;main.wasm&#34;</span><span>))</span>
</span></span><span><span><span>if</span> <span>err</span> <span>!=</span> <span>nil</span> <span>{</span>
</span></span><span><span>	<span>respondWithError</span><span>(</span><span>w</span><span>,</span> <span>500</span><span>,</span> <span>err</span><span>.</span><span>Error</span><span>())</span>
</span></span><span><span>	<span>return</span>
</span></span><span><span><span>}</span>
</span></span><span><span><span>w</span><span>.</span><span>Write</span><span>(</span><span>dat</span><span>)</span>
</span></span></code></pre></div><h2 id="frontend---executing-the-wasm-bundle">
  <span> Frontend - Executing the WASM Bundle</span> <a href="#frontend---executing-the-wasm-bundle">üîó</a></h2>
<p>The Rust front-end has a lot of similarities to the Go front end. They both use Web Workers to optimize the user experience of executing potentially expensive code in the browser. If you need to catch-up on how that‚Äôs done, read up on my <a href="https://blog.boot.dev/golang/running-go-in-the-browser-wasm-web-workers/">web workers explanation here</a>.</p>
<p>The main difference here comes down to the <code>rust_worker.js</code> file. The equivalent of <code>go_worker.js</code> from the referenced article:</p>
<div><pre tabindex="0"><code data-lang="js"><span><span><span>// send(line) sends a single line of stdout back to the browser to // be rendered in the on-screen console
</span></span></span><span><span><span></span><span>function</span> <span>send</span><span>(</span><span>line</span><span>)</span> <span>{</span>
</span></span><span><span>  <span>postMessage</span><span>({</span>
</span></span><span><span>    <span>message</span><span>:</span> <span>readString</span><span>(</span><span>line</span><span>),</span>
</span></span><span><span>  <span>});</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>// keep a WebAssembly memory reference for readString
</span></span></span><span><span><span></span><span>let</span> <span>memory</span><span>;</span>
</span></span><span><span>
</span></span><span><span><span>// read a null terminated c string at a wasm memory buffer index
</span></span></span><span><span><span></span><span>function</span> <span>readString</span><span>(</span><span>ptr</span><span>)</span> <span>{</span>
</span></span><span><span>  <span>const</span> <span>view</span> <span>=</span> <span>new</span> <span>Uint8Array</span><span>(</span><span>memory</span><span>.</span><span>buffer</span><span>);</span>
</span></span><span><span>
</span></span><span><span>  <span>let</span> <span>end</span> <span>=</span> <span>ptr</span><span>;</span>
</span></span><span><span>  <span>while</span> <span>(</span><span>view</span><span>[</span><span>end</span><span>])</span> <span>++</span><span>end</span><span>;</span>
</span></span><span><span>
</span></span><span><span>  <span>const</span> <span>buf</span> <span>=</span> <span>new</span> <span>Uint8Array</span><span>(</span><span>view</span><span>.</span><span>subarray</span><span>(</span><span>ptr</span><span>,</span> <span>end</span><span>));</span>
</span></span><span><span>  <span>return</span> <span>new</span> <span>TextDecoder</span><span>().</span><span>decode</span><span>(</span><span>buf</span><span>);</span>
</span></span><span><span><span>}</span>
</span></span><span><span>
</span></span><span><span><span>// addEventListener is a handler that get&#39;s called whenever the
</span></span></span><span><span><span>// main thread (editor) sends us some WASM to execute
</span></span></span><span><span><span></span><span>addEventListener</span><span>(</span>
</span></span><span><span>  <span>&#34;message&#34;</span><span>,</span>
</span></span><span><span>  <span>async</span> <span>(</span><span>e</span><span>)</span> <span>=&gt;</span> <span>{</span>
</span></span><span><span>    <span>const</span> <span>result</span> <span>=</span> <span>await</span> <span>WebAssembly</span><span>.</span><span>instantiate</span><span>(</span><span>e</span><span>.</span><span>data</span><span>,</span> <span>{</span>
</span></span><span><span>      <span>// here we define the print, eprint, and trace
</span></span></span><span><span><span></span>      <span>// functions as specified in the glue from above
</span></span></span><span><span><span></span>      <span>// they just send stdout back using the send function
</span></span></span><span><span><span></span>      <span>env</span><span>:</span> <span>{</span>
</span></span><span><span>        <span>print</span><span>(</span><span>ptr</span><span>)</span> <span>{</span>
</span></span><span><span>          <span>send</span><span>(</span><span>ptr</span><span>);</span>
</span></span><span><span>        <span>},</span>
</span></span><span><span>        <span>eprint</span><span>(</span><span>ptr</span><span>)</span> <span>{</span>
</span></span><span><span>          <span>send</span><span>(</span><span>ptr</span><span>);</span>
</span></span><span><span>        <span>},</span>
</span></span><span><span>        <span>trace</span><span>(</span><span>ptr</span><span>)</span> <span>{</span>
</span></span><span><span>          <span>send</span><span>(</span><span>ptr</span><span>);</span>
</span></span><span><span>        <span>},</span>
</span></span><span><span>      <span>},</span>
</span></span><span><span>    <span>});</span>
</span></span><span><span>
</span></span><span><span>    <span>memory</span> <span>=</span> <span>result</span><span>.</span><span>instance</span><span>.</span><span>exports</span><span>.</span><span>memory</span><span>;</span>
</span></span><span><span>
</span></span><span><span>    <span>// run the main() function of the WASM code
</span></span></span><span><span><span></span>    <span>await</span> <span>result</span><span>.</span><span>instance</span><span>.</span><span>exports</span><span>.</span><span>main</span><span>();</span>
</span></span><span><span>
</span></span><span><span>    <span>// let the editor know we&#39;ve sent all the output and have
</span></span></span><span><span><span></span>    <span>// finished
</span></span></span><span><span><span></span>    <span>postMessage</span><span>({</span>
</span></span><span><span>      <span>done</span><span>:</span> <span>true</span><span>,</span>
</span></span><span><span>    <span>});</span>
</span></span><span><span>  <span>},</span>
</span></span><span><span>  <span>false</span>
</span></span><span><span><span>);</span>
</span></span></code></pre></div>  

<div>
  <h3>Find a problem with this article?</h3>
  <p><a target="_blank" href="https://github.com/bootdotdev/blog/issues">Report an issue on GitHub</a>
</p></div>
 
        </div></div>
        </section>
    </article>
</main>
</body>
</html>
