<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Semgrep üëÄ | Rahul Vishwakarma Blog</title>
    <link rel="stylesheet" type="text/css" href="../styles.css" media="screen" />
</head>
<body>
<header>
    <nav>
        <a href="/index.html" aria-label="Go back to the homepage">‚Üê Back</a>
        <a href="https://highgrowthengineering.substack.com/p/semgrep-" target="_blank" rel="noopener noreferrer">
            View Original
        </a>
    </nav>
</header>

<main>
    <article>
        <h1>Semgrep üëÄ</h1>
        <section>
            
            <p>&#128075; Hello hello!</p><p>I know, it&#8217;s been around a month since my last post. I&#8217;ve received a few queries, including one from my own mother, asking where the newsletter has gone. Have I gone off it already? </p><p>Fear not. I&#8217;ve been off on holiday celebrating a big birthday, and wanted to take a total break from work and writing. I didn&#8217;t want to spam your inboxes sending an additional issue just to tell you this. Now, I&#8217;m back, re-energised, and ready to go. &#9786;&#65039;</p><p>If this is your first time here, hello! I&#8217;ve spent the past 7 years working for high growth companies. My path has followed a &#8216;do-what-needs-to-be-done&#8217; path: software engineering, data science, machine learning, with a little product management thrown in for good measure. I&#8217;ve picked up some useful experience at the intersection of these disciplines, and I&#8217;d love to share it with you.</p><p>The goal of this newsletter is to discuss techniques for&nbsp;<strong>building better software&nbsp;</strong>and&nbsp;<strong>being more effective&nbsp;</strong>in&nbsp;<strong>high growth companies</strong>. I mix in longer form content &#8212; think a short blog post that you could read in 5 minutes &#8212; with some of my favourite links. Here&#8217;s some really popular posts from the past few months:</p><ul><li><p><a href="https://highgrowthengineering.substack.com/p/why-is-dbt-so-important-">Why is dbt so important? &#128202;</a></p></li><li><p><a href="https://highgrowthengineering.substack.com/p/beware-the-mean-">Beware the mean &#128201;</a></p></li><li><p><a href="https://highgrowthengineering.substack.com/p/the-power-of-static-analysis-">The power of static analysis &#129302;</a></p></li><li><p><a href="https://highgrowthengineering.substack.com/p/the-power-of-proposals-">The power of proposals &#9997;&#65039;</a></p></li></ul><p>Stephen</p><p class="button-wrapper" data-attrs="{&quot;url&quot;:&quot;https://twitter.com/sjwhitworth&quot;,&quot;text&quot;:&quot;Follow me on Twitter &#128038;&quot;,&quot;action&quot;:null,&quot;class&quot;:null}" data-component-name="ButtonCreateButton"><a class="button primary" href="https://twitter.com/sjwhitworth"><span>Follow me on Twitter &#128038;</span></a></p><div><hr></div><h1>Semgrep</h1><p>This week, I found a tool that I think is quite revolutionary. That doesn&#8217;t happen very often. The last time I remember was <a href="https://highgrowthengineering.substack.com/p/why-is-dbt-so-important-">dbt</a>, and we all know how much I go on about that thing. So, you, at the back &#8212; sit up and take note! </p><p>It&#8217;s called <a href="https://github.com/returntocorp/semgrep">semgrep</a>. Quoting from the website:</p><ul><li><p>It&#8217;s a simple, customizable, and fast static analysis tool for finding bugs</p></li><li><p>Combines the&nbsp;<a href="https://r2c.dev/blog/2020/semgrep-stop-grepping-code/">speed and customizability of grep</a>&nbsp;with the precision of traditional static analysis tools</p></li><li><p>No painful domain-specific language; Semgrep rules look like the source code you&#8217;re targeting</p></li><li><p>Runs offline on uncompiled code in CI, at pre-commit, or in the editor</p></li><li><p><a href="https://github.com/returntocorp/semgrep">Open-source</a>&nbsp;maintained and&nbsp;<a href="https://r2c.dev/">commercially supported by r2c</a></p></li></ul><p>As of September 2020, it explicitly supports the following languages:</p><ul><li><p>Go</p></li><li><p>Java</p></li><li><p>JavaScript</p></li><li><p>JSON</p></li><li><p>Python</p></li><li><p>Ruby (beta)</p></li><li><p>JSX (beta)</p></li><li><p>C (alpha)</p></li><li><p>OCaml (alpha)</p></li></ul><p>Confused as to what static analysis is? No worry. I&#8217;d highly recommend reading my previous issue to get yourself situated before coming back to this issue: <strong><a href="https://highgrowthengineering.substack.com/p/the-power-of-static-analysis-">The power of static analysis &#129302;</a></strong></p><h3>So, how does it work?</h3><p>Although the tool has <a href="https://man7.org/linux/man-pages/man1/grep.1.html">grep</a> in the title, the similarities end quickly! </p><p>grep is a general purpose tool used to find regular expressions in text. semgrep is a tool for running arbitrary rules on <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax trees</a>.  This means that it is far more powerful than text based matching, and can understand references, statements, conditionals, and more. It applies rules to source code to check if the desired pattern is found in the source code, highlighting the instances that it finds. When it finds some instances, you can simply log them, or have semgrep exit with a particular status code &#8212; useful for implementing as part of continuous integration.</p><p>semgrep rules are generally written in the language of the code that you&#8217;re targeting, with a small domain specific language to spice things up. This means that there is a very limited domain specific language for you to learn, and you can use all of the knowledge you already have about the programming language. This flattens the learning curve.</p><p>But why is this necessary? Can&#8217;t we just use grep to find issues in your code? No! To get past a certain level of complexity, you need a tool that actually understands the structure of the programming language, as opposed to pure text. This rich representation means you can do much more powerful selections such as subexpressions, checking when any statements are equivalent to each other, and so on. </p><h3>How do I use it?</h3><p>To run semgrep, you use the command line utility, or CLI. Pass in some configuration which contains the rules you want to run, and let it do its thing. In this example, I&#8217;m running a toy check that ensures that we defer an Unlock straight after we lock an object &#8212; see <a href="https://github.com/sjwhitworth/semgrep-messing/tree/master/lock">the rule on GitHub here</a>. </p><p>semgrep spots the issue, provides a warning message, and provides an autofix. If you want to apply fixes automatically, just pass the <strong>-a</strong> flag.</p><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png" width="1456" height="376" data-attrs="{&quot;src&quot;:&quot;https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com/public/images/d8883732-a56c-41de-9cde-69134e5fa706_1836x474.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:376,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:102770,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8883732-a56c-41de-9cde-69134e5fa706_1836x474.png 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><div class="pencraft pc-reset icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></div><div class="pencraft pc-reset icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></div></div></a><h3>Can I see some more examples?</h3><p>Sure, let&#8217;s go through some toy examples. A warning: examples are not designed to be totally exhaustive or correct in all circumstances. Caveat emptor!</p><h5>Useless equality checks</h5><p>A simple one from the semgrep website. This rule checks if you have an expression where the left and right hand side of the expression are the same.</p><pre><code><code>rules:
- id: useless-equality
  pattern: |
    $X == $X
  message: |
    The left- and right-hand sides of this expression are identical.
</code></code></pre><p>This might seem like an obvious mistake, but it&#8217;s surprisingly common! When I scanned the Monzo codebase, I found an example of some test code that was comparing the equality of two structs that suffered from this issue.</p><h5>Using APIs correctly</h5><p>Now, let&#8217;s get a little more advanced. The below example checks whether you&#8217;ve created an <a href="https://godoc.org/golang.org/x/sync/errgroup#Group">errgroup.Group</a>, but forgot to call Wait on it. If you don&#8217;t call Wait, you won&#8217;t block waiting for functions called in goroutines to finish, nor will you report errors correctly.</p><pre><code><code>rules:
- id: find-unwaited-errgroup
  patterns:
    - pattern-either: 
      - pattern: |
          # Assign the group and context variable to 
          # semgrep metavariables. The ellipses mean that 
          # any arguments can be passed to this function.
          $X, $Y := errgroup.WithContext(...)
      - pattern: |
          $X := errgroup.Group{}
    - pattern-not-inside: |
        # The ellipses denotes an arbitrary amount of code
        # in the current scope. Other functions can be
        # be called here.
        ...
        # Ensure Wait is called on $X, which we declared
        # as a metavariable earlier on.
        $X.Wait()
  message: |
    You created an errgroup named $X, but never called Wait on it.
 </code></code></pre><h3>How can I use it?</h3><p>I think there&#8217;s three main ways to get a lot of value out of semgrep at an high growth engineering organisation.</p><h4>It&#8217;s a way to query code</h4><p>Firstly, semgrep is a tool to better understand the structure of your current codebase and the patterns within it. You can write queries that run over your codebase, without having to write custom AST analysis code to do it. For example, you could answer the following questions very easily:</p><ul><li><p>How many microservice handlers are registered that perform no authorization checks?</p></li><li><p>How many mutexes do we rely on explicitly unlocking, instead of deferring the unlock immediately? </p></li><li><p>How many database interactions use dynamic string formatting instead of constants?</p></li></ul><p>Although it might seem like a way to answer curiosities, being able to understand the structure of your codebase is very useful in a practical sense. For example:</p><ul><li><p>You can quickly understand the exposure that your codebase has to a particular vulnerability.</p></li><li><p>You can estimate the size and complexity of an API migration by quickly analysing all of the callers.</p></li></ul><p>These are all extremely relevant questions when your codebase is growing rapidly! &#128513;</p><h4>It&#8217;s a static analysis tool to spot issues</h4><p>The natural extension of finding issues in your codebase is adding checks to ensure that those issues can&#8217;t return. You can use the rules that you&#8217;ve written to highlight unwanted, incorrect or dangerous use of code, and prevent that code from getting checked in to master. This helps keep the bar for correctness and code quality high.</p><p>As with any static analysis tool, I&#8217;d recommend using it both during development (as part of pre-commit hooks) and in continuous integration (on your CI server). This keeps the loop between writing code and getting feedback nice and tight.</p><p>Do you have to generate all of your rules from scratch? Nope. Rule files can be shared amongst the community, so you can benefit from the work of others. There&#8217;s a ton on the <a href="https://semgrep.dev/rulesets">Semgrep registry</a> for many different languages. There&#8217;s also quite a few community contributions scattered around the internet. For example, <a href="https://github.com/dgryski/semgrep-go/">here&#8217;s a great set of rules</a> by Damian Gryski for Go. </p><p>A key part to highlight here is the flexibility of semgrep. It&#8217;s not just a linting tool that runs a preset list of checks. Because rules are user-specified, it&#8217;s a way to enforce norms that specific to you or your company. Perhaps one object must always be initialised in main.go before the other. You might need always need to call a custom authorization function at the start of every handler before you can perform any business logic. Perhaps you don&#8217;t permit package level globals at all. You can use the extensibility of Semgrep to continually enforce all of these norms.</p><h4>It&#8217;s a way to automatically fix those issues</h4><p><a href="https://github.com/returntocorp/semgrep/blob/develop/docs/experimental.md#autofix">Autofixing</a> is an experimental feature within semgrep, allowing you to use simple replacement, or regular expressions, to automatically fix issues raised by semgrep. To do this, provide a <a href="https://github.com/sjwhitworth/semgrep-messing/blob/master/lock/defer-unlock.yml#L12-L14">fix key</a> in your rule specification. When semgrep is run with the <strong>-a</strong> flag, it will automatically fix the issue that it spots. </p><p>I think there&#8217;s some really nice ways to apply this to developer workflows. First, you could run this automatically as part of a pre-commit hook. Issues would automatically be fixed for developers. Second, you could try and use this functionality for mass-refactors or migrations.</p><p>As it&#8217;s experimental, the power of auto-fixing is currently somewhat limited. But it&#8217;s more than good enough to directly swap out functions, or perform some basic refactors. Give it a spin!</p><h3>Limitations</h3><p>When trying to express rules with a certain level of complexity, you start to hit some brick walls. Let&#8217;s go through some examples.</p><p>We allocate a structure in a New() function. As part of this initialisation, a mutex is allocated, and immediately locked. The mutex is then unlocked at some arbitrary point in the future in a totally separate function: e.g. Close(). Right now, I don&#8217;t think semgrep can trace calls across all of these functions to ensure that the mutex is eventually unlocked. It&#8217;s a lot easier to write checks that look at the current scope, or child scopes.</p><p>Another check that I think would be hard to implement in semgrep: ensuring all fields from a particular have been copied into all fields or subfields of another structure. I&#8217;m not sure how you&#8217;d express a fully generic check over any structure in this way. It&#8217;s very possible that this may just be my inexperience with the tool however, so take it with a pinch of salt!</p><h3>Other tools</h3><p>It&#8217;s also worth taking a look at other tools that do similar things. A referral from a colleague pointed me to <a href="https://help.semmle.com/QL/learn-ql/">CodeQL</a> from GitHub. After taking a quick look at this, it looks very powerful, but quite a bit more complex than semgrep. I&#8217;d be tempted to use this if I wanted to build the above checks that I&#8217;d find challenging with semgrep. I think I&#8217;d find it much harder to explain, however &#8212; which would mean adoption within an organisation is likely to be poorer.</p><p>There&#8217;s also commercial offerings like <a href="https://www.sonarqube.org/">SonarQube</a> and <a href="https://www.codacy.com/">Codacy</a>, but I have no experience with them, so can&#8217;t speak to their quality.</p><h3>Summary</h3><p>First and foremost, Semgrep is a powerful and flexible tool for understanding your codebase, and improving the quality and correctness of it. We&#8217;re in the process of testing it out at Monzo by adding it on top of our existing static analysis tools. If you like what you&#8217;ve seen in this post, it&#8217;s probably worth testing out in your organisation too. Let me know how you get on.</p><p>Secondly, semgrep feels like a useful primitive to <strong>build tools</strong> <strong>on top</strong> of. Being able to understand the syntax tree of multiple different languages seems like a powerful lego block to build other things with. These sorts of tools could be vulnerability scanners, performance optimisers, migration tools, and automatic documentation builders. </p><p>Semgrep is a tool well adapted to answering questions and fixing the problems you face in high growth engineering organisations. It&#8217;s early days, but I&#8217;m excited to see what people can do with it!</p><div><hr></div><h1><strong>Best of the internet &#128279;</strong></h1><p>Every week, I collate some of my favourite links to share. Found something cool, or built something great? Send it to me by replying to this email and I might include it in the next edition. &#128231;</p><h4><a href="https://www.youtube.com/watch?v=kVhSbHoBSH0&amp;feature=emb_title">Network Isolation For 1500 Microservices - Jack Kleeman</a></h4><div id="youtube2-kVhSbHoBSH0" class="youtube-wrap" data-attrs="{&quot;videoId&quot;:&quot;kVhSbHoBSH0&quot;,&quot;startTime&quot;:null,&quot;endTime&quot;:null}" data-component-name="Youtube2ToDOM"><div class="youtube-inner"><iframe src="https://www.youtube-nocookie.com/embed/kVhSbHoBSH0?rel=0&amp;autoplay=0&amp;showinfo=0&amp;enablejsapi=0" frameborder="0" loading="lazy" gesture="media" allow="autoplay; fullscreen" allowautoplay="true" allowfullscreen="true" width="728" height="409"></iframe></div></div><p>I used to work with Jack &#8212; he&#8217;s great, and so is this video! It details how network isolation was implemented at Monzo. Well worth your time.</p><h4><a href="https://www.youtube.com/watch?v=y3jCLEPL0As&amp;feature=emb_title">r2c meetup: Writing Semgrep rules for security, correctness, performance, and more</a></h4><div id="youtube2-y3jCLEPL0As" class="youtube-wrap" data-attrs="{&quot;videoId&quot;:&quot;y3jCLEPL0As&quot;,&quot;startTime&quot;:null,&quot;endTime&quot;:null}" data-component-name="Youtube2ToDOM"><div class="youtube-inner"><iframe src="https://www.youtube-nocookie.com/embed/y3jCLEPL0As?rel=0&amp;autoplay=0&amp;showinfo=0&amp;enablejsapi=0" frameborder="0" loading="lazy" gesture="media" allow="autoplay; fullscreen" allowautoplay="true" allowfullscreen="true" width="728" height="409"></iframe></div></div><p>Here&#8217;s a nice introductory video for how to use semgrep from the commercial supporters of the tool.</p><h4><a href="https://github.com/loov/goda">Goda: a Go dependency analysis toolkit</a></h4><p>Here&#8217;s a nice little tool for slicing, dicing and visualising the dependency graph of your Go code.</p><h4><a href="https://ofabry.github.io/go-callvis/">go-callvis</a></h4><p>Wow, I guess I&#8217;m really going all out on the Go stuff today. May as well commit. As with Goda for dependencies, this is a nice way to pull apart the call graph &#8212; which function calls what &#8212; of your program. For large or complex codebases, this can make things a little easier to understand.</p><div><hr></div><p>That&#8217;s all from this week&#8217;s High Growth Engineering. If you enjoyed it, I&#8217;d really appreciate it if you could do one of the following:</p><ul><li><p>Share it with a friend that would find it useful.</p></li><li><p>Follow me on Twitter: <a href="https://twitter.com/sjwhitworth">@sjwhitworth</a></p></li><li><p>Subscribe: just hit the button below.</p></li></ul><p class="button-wrapper" data-attrs="{&quot;url&quot;:&quot;https://highgrowthengineering.substack.com/subscribe?&quot;,&quot;text&quot;:&quot;Subscribe now&quot;,&quot;action&quot;:null,&quot;class&quot;:null}" data-component-name="ButtonCreateButton"><a class="button primary" href="https://highgrowthengineering.substack.com/subscribe?"><span>Subscribe now</span></a></p><p>All the best,</p><p>Stephen</p><p></p>
        </section>
    </article>
</main>
</body>
</html>
