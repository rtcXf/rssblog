<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>We saw some really bad Intel CPU bugs in 2015 and we should expect to see more in the future | Rahul Vishwakarma Blog</title>
    <link rel="stylesheet" type="text/css" href="../styles.css" media="screen" />
</head>
<body>
<header>
    <nav>
        <a href="/index.html" aria-label="Go back to the homepage">← Back</a>
        <a href="https://danluu.com/cpu-bugs/" target="_blank" rel="noopener noreferrer">
            View Original
        </a>
    </nav>
</header>

<main>
    <article>
        <h1>We saw some really bad Intel CPU bugs in 2015 and we should expect to see more in the future</h1>
        <section>
            
            <div id="readability-page-1" class="page"><div> <p>2015 was a pretty good year for Intel. Their quarterly earnings reports exceeded expectations every quarter. They continue to be the only game in town for the serious server market, which continues to grow exponentially; from the earnings reports of the two largest cloud vendors, we can see that AWS and Azure grew by 80% and 100%, respectively. That growth has effectively offset the damage Intel has seen from the continued decline of the desktop market. For a while, it looked like <a href="https://danluu.com/new-cpu-features/#update">cloud vendors might be able to avoid the Intel tax by moving their computation onto FPGAs</a>, but Intel bought one of the two serious FPGA vendors and, combined with their fab advantage, they look well positioned to dominate the high-end FPGA market the same way they&#39;ve been dominating the high-end server CPU market. Also, their fine for anti-competitive practices turned out to be $1.45B, much less than the benefit they gained from their anti-competitive practices.</p> <p>Things haven&#39;t looked so great on the engineering/bugs side of things, though. We&#39;ve seen a number of fairly serious CPU bugs and it looks like we should expect more in the future. I don&#39;t keep track of Intel bugs unless they&#39;re so serious that people I know are scrambling to get a patch in because of the potential impact, and I still heard about two severe bugs this year in the last quarter of the year alone. First, there was the <a href="http://xenbits.xen.org/xsa/advisory-156.html">bug found by Ben Serebrin and Jan Beulic</a>, which allowed a guest VM to fault in a way that would cause the CPU to hang in a microcode infinite loop, allowing any VM to DoS its host.</p>  <p>Major cloud vendors were quite lucky that this bug was found by a Google engineer, and that Google decided to share its knowledge of the bug with its competitors before publicly disclosing. Black hats spend a lot of time trying to take down major services. I&#39;m actually really impressed by both the persistence and the cleverness of the people who spend their time attacking the companies I work for. If, buried deep in our infrastructure, we have a bit of code running at <a href="https://en.wikipedia.org/wiki/Deferred_Procedure_Call">DPC</a> that&#39;s vulnerable to slowdown because of some kind of hash collision, someone will find and exploit that, even if it takes a long and obscure sequence of events to make it happen. If this CPU microcode hang had been found by one of these black hats, there would have been major carnage for most cloud hosted services at the most inconvenient possible time.</p> <p>Shortly after the Serebrin/Beulic bug was found, a group of people found that running <a href="http://www.mersenne.org/download/">prime95</a>, a commonly used tool for benchmarking and burn-in, causes <a href="http://mersenneforum.org/showthread.php?t=20714">their entire system to lock up</a>. <a href="https://communities.intel.com/thread/96157?start=15&amp;tstart=0">Intel&#39;s response to this was</a>:</p> <blockquote> <p>Intel has identified an issue that potentially affects the 6th Gen Intel® Core™ family of products. This issue only occurs under certain complex workload conditions, like those that may be encountered when running applications like Prime95. In those cases, the processor may hang or cause unpredictable system behavior.</p> </blockquote> <p>which reveals almost nothing about what&#39;s actually going on. If you look at their errata list, you&#39;ll find that this is typical, except that they normally won&#39;t even name the application that was used to trigger the bug. For example, <a href="http://www.intel.com/content/dam/www/public/us/en/documents/specification-updates/4th-gen-core-family-desktop-specification-update.pdf">one of the current errata lists</a> has entries like</p> <ul> <li>Certain Combinations of AVX Instructions May Cause Unpredictable System Behavior</li> <li>AVX Gather Instruction That Should Result in #DF May Cause Unexpected System Behavior</li> <li>Processor May Experience a Spurious LLC-Related Machine Check During Periods of High Activity</li> <li>Page Fault May Report Incorrect Fault Information</li> </ul> <p>As we&#39;ve seen, “unexpected system behavior” can mean that we&#39;re completely screwed. Machine checks aren&#39;t great either -- they cause Windows to blue screen and Linux to kernel panic. An incorrect address on a page fault is potentially even worse than a mere crash, and if you dig through the list you can find a lot of other scary sounding bugs.</p> <p>And keep in mind that the Intel errata list has the following disclaimer:</p> <blockquote> <p>Errata remain in the specification update throughout the product&#39;s lifecycle, or until a particular stepping is no longer commercially available. Under these circumstances, errata removed from the specification update are archived and available upon request.</p> </blockquote> <p>Once they stop manufacturing a stepping (the hardware equivalent of a point release), they reserve the right to remove the errata and you won&#39;t be able to find out what errata your older stepping has unless you&#39;re important enough to Intel.</p> <p>Anyway, back to 2015. We&#39;ve seen at least two serious bugs in Intel CPUs in the last quarter, and it&#39;s almost certain there are more bugs lurking. Back when I worked at a company that produced Intel compatible CPUs, we did a fair amount of testing and characterization of Intel CPUs; as someone fresh out of school who&#39;d previously assumed that CPUs basically worked, I was surprised by how many bugs we were able to find. Even though I never worked on the characterization and competitive analysis side of things, I still personally found multiple Intel CPU bugs just in the normal course of doing my job, poking around to verify things that seemed non-obvious to me. Turns out things that seem non-obvious to me are sometimes also non-obvious to Intel engineers. As more services move to the cloud and the impact of system hang and reset vulnerabilities increases, we&#39;ll see more black hats investing time in finding CPU bugs. We should expect to see a lot more of these when people realize that it&#39;s much easier than it seems to find these bugs. There was a time when a CPU family might only have one bug per year, with serious bugs happening once every few years, or even once a decade, but we&#39;ve moved past that. In part, that&#39;s because &#34;unpredictable system behavior&#34; have moved from being an annoying class of bugs that forces you to restart your computation to an attack vector that lets anyone with an AWS account attack random cloud-hosted services, but it&#39;s mostly because CPUs <a href="https://danluu.com/new-cpu-features/">have gotten more complex, making them more difficult to test</a> and <a href="https://danluu.com/cpu-backdoors/">audit</a> effectively, while Intel appears to be cutting back on validation effort. Ironically, we have hardware virtualization that&#39;s supposed to help us with security, but the virtualization is so complicated that the hardware virtualization implementation is likely to expose &#34;unpredictable system behavior&#34; bugs that wouldn&#39;t otherwise have existed. This isn&#39;t to say it&#39;s hopeless -- it&#39;s possible, in principle, to design CPUs such that a hang bug on one core doesn&#39;t crash the entire system. It&#39;s just that it&#39;s a fair amount of work to do that at every level (cache directories, the uncore, etc., would have to be modified to operate when a core is hung, as well as OS schedulers). No one&#39;s done the work because it hasn&#39;t previously seemed important.</p> <p>You&#39;ll often hear software folks say that these things don&#39;t matter because they can (sometimes) be patched. But, many devices will never get patched, which means that hardware security bugs will leave some devices vulnerable for their entire lifetime. And even if you don&#39;t care about consumers, serious bugs are very bad for CPU vendors. At a company I worked for, we once had a bug escape validation and get found after we shipped. One OEM wouldn&#39;t talk to us for something like five years after that, and other OEMs that continued working with us had to re-qualify their parts with our microcode patch and they made sure to let us know how expensive that was. Intel has enough weight that OEMs can&#39;t just walk away from them after a bug, but they don&#39;t have unlimited political capital and every serious bug uses up political capital, even if it can be patched.</p> <p>This isn&#39;t to say that we should try to get to zero bugs. There&#39;s always going to be a trade off between development speed and and bug rate and the optimal point probably isn&#39;t zero bugs. But we&#39;re now regularly seeing severe bugs with security implications, which changes the tradeoff a lot. With something like the <a href="https://en.wikipedia.org/wiki/Pentium_FDIV_bug">FDIV bug</a> you can argue that it&#39;s statistically unlikely that any particular user who doesn&#39;t run numerical analysis code will be impacted, but security bugs are different. Attackers don&#39;t run random code, so you can&#39;t just say that it&#39;s unlikely that some condition will occur.</p> <h3 id="update">Update</h3> <p>After writing this, a person claiming to be an ex-Intel employee said &#34;even with your privileged access, you have no idea&#34; and a pseudo-anonymous commenter on reddit <a href="https://www.reddit.com/r/programming/comments/41k3yx/we_saw_some_really_bad_intel_cpu_bugs_in_2015_and/cz2zwag">made this comment</a>:</p> <blockquote> <p>As someone who worked in an Intel Validation group for SOCs until mid-2014 or so I can tell you, yes, you will see more CPU bugs from Intel than you have in the past from the post-FDIV-bug era until recently.</p> <p>Why?</p> <p>Let me set the scene: It&#39;s late in 2013. Intel is frantic about losing the mobile CPU wars to ARM. Meetings with all the validation groups. Head honcho in charge of Validation says something to the effect of: &#34;We need to move faster. Validation at Intel is taking much longer than it does for our competition. We need to do whatever we can to reduce those times... we can&#39;t live forever in the shadow of the early 90&#39;s FDIV bug, we need to move on. Our competition is moving much faster than we are&#34; - I&#39;m paraphrasing. Many of the engineers in the room could remember the FDIV bug and the ensuing problems caused for Intel 20 years prior. Many of us were aghast that someone highly placed would suggest we needed to cut corners in validation - that wasn&#39;t explicitly said, of course, but that was the implicit message. That meeting there in late 2013 signaled a sea change at Intel to many of us who were there. And it didn&#39;t seem like it was going to be a good kind of sea change. Some of us chose to get out while the getting was good. As someone who worked in an Intel Validation group for SOCs until mid-2014 or so I can tell you, yes, you will see more CPU bugs from Intel than you have in the past from the post-FDIV-bug era until recently.</p> </blockquote> <p>I haven&#39;t been able to confirm this story from another source I personally know, although another anonymous commenter said &#34;I left INTC in mid 2013. From validation. This ... is accurate compared with my experience.&#34; Another anonymous person, someone I know, didn&#39;t hear that speech, but found that at around that time, &#34;velocity&#34; became a buzzword and management spent a lot of time talking about how Intel needs more &#34;velocity&#34; to compete with ARM, which appears to confirm the sentiment, if not the actual speech.</p> <p>I&#39;ve also heard from formal methods people that, around the-timeframe mentioned in the first comment, there was an exodus of formal verification folks. One story I&#39;ve heard is that people left because they were worried about being made redundant. I&#39;m told that, at the time, early retirement packages were being floated around and people strongly suspected layoffs. Another story I&#39;ve heard is that things got really strange due to Intel&#39;s focus on the mobile battle with ARM, and people wanted to leave before things got even worse. But it&#39;s hard to say of this means anything, since Intel has been losing a lot of people to Apple because Apple offers better compensation packages and the promise of being less dysfunctional.</p> <p>I also got anonymous stories about bugs. One person who works in HPC told me that when they were shopping for Haswell parts, a little bird told them that they&#39;d see drastically reduced performance on variants with greater than 12 cores. When they tried building out both 12-core and 16-core systems, they found that they got noticeably better performance on their 12-core systems across a wide variety of workloads. That&#39;s not better per-core performance -- that&#39;s better absolute performance. Adding 4 more cores reduced the performance on parallel workloads! That was true both in single-socket and two-socket benchmarks.</p> <p>There&#39;s also <a href="http://www.tomshardware.com/forum/id-2830772/skylake-build-randomly-freezing-crashing.html">a mysterious hang during idle/low-activity bug that Intel doesn&#39;t seem to have figured out yet</a>.</p> <p>And then there&#39;s <a href="https://bugzilla.kernel.org/show_bug.cgi?id=103351">this Broadwell bug that hangs Linux if you don&#39;t disable low-power states</a>.</p> <p>And of course Intel isn&#39;t the only company with bugs -- this <a href="https://lists.debian.org/debian-security/2016/03/msg00084.html">AMD bug found by Robert Swiecki</a> not only allows a VM to crash its host, it also allows a VM to take over the host.</p> <p>I doubt I&#39;ve even heard of all the recent bugs and stories about verification/validation. Feel free to send other reports my way.</p> <h3 id="more-updates">More updates</h3> <p>A number of folks have noticed <a href="https://forum.synology.com/enu/viewtopic.php?f=7&amp;t=119727&amp;start=60">unusual failure rates in storage devices</a> and switches. This <a href="https://www.servethehome.com/intel-atom-c2000-series-bug-quiet/">appears to be related to an Intel Atom bug</a>. I find this interesting because the Atom is a relatively simple chip, and therefore a relatively simple chip to verify. When the first-gen Atom was released, folks at Intel seemed proud of how few internal spins of the chip were needed to ship a working production chip that, something made possible by the simplicity of the chip. Modern Atoms are more complicated, but not <em>that</em> much more complicated.</p> <p>Intel Skylake and Kaby Lake have <a href="https://lists.debian.org/debian-devel/2017/06/msg00308.html">a hyperthreading bug that&#39;s so serious that Debian recommends that users disable hyperthreading to avoid the bug</a>, which can &#34;cause spurious errors, such as application and system misbehavior, data corruption, and data loss&#34;.</p> <p>On the AMD side, there might be <a href="https://community.amd.com/message/2796982">a bug that&#39;s as serious any recent Intel CPU bug</a>. If you read that linked thread, you&#39;ll see an AMD representative asking people to disable SMT, OPCache Control, and changing LLC settings to possibly mitigate or narrow down a serious crashing bug. On <a href="https://forums.gentoo.org/viewtopic-t-1061546-postdays-0-postorder-asc-start-150.html">another thread</a>, you can find someone reporting an #MC exception with &#34;u-op cache crc mismatch&#34;.</p> <p>Although AMD&#39;s response in the forum was that these were isolated issues, <a href="http://www.phoronix.com/scan.php?page=article&amp;item=ryzen-segv-continues">phoronix was able to reproduce crashes by running a stress test that consists of compiling a number of open source programs</a>. They report they were able to get 53 segfaults with one hour of attempted compilation.</p> <p>Some FreeBSD folks have also noticed seemingly unrelated crashes and have been able to get a reproduction by running code at a high address and then firing an interrupt. <a href="https://svnweb.freebsd.org/base?view=revision&amp;revision=321899">This can result in a hang or a crash</a>. The reason this appears to be unrelated to the first reported Ryzen issues is that this is easily reproducible with SMT disabled.</p> <p>Matt Dillon found an AMD bug triggered by DragonflyBSD, and <a href="http://gitweb.dragonflybsd.org/dragonfly.git/commitdiff/b48dd28447fc8ef62fbc963accd301557fd9ac20">commited a tiny patch to fix it</a>:</p> <blockquote> <p>There is a bug in Ryzen related to the kernel iretq&#39;ing into a high user %rip address near the end of the user address space (top of user stack). This is a temporary workaround for the issue.</p> <p>The original %rip for sigtramp was 0x00007fffffffffe0. Moving it down to fa0 wasn&#39;t sufficient. Moving it down to f00 moved the bug from nearly instant to taking a few hours to reproduce. Moving it down to be0 it took a day to reproduce. Moving it down to 0x00007ffffffffba0 (this commit) survived the overnight test.</p> </blockquote> <h3 id="meltdown-spectre-https-meltdownattack-com-update"><a href="https://meltdownattack.com/">Meltdown / spectre</a> update</h3> <p>This is an interesting class of attack that takes advantage of speculative execution plus side channel attacks to leak privileged information into user processes. It seems that at least some of these attacks be done from javascript in the browser.</p> <p>Regarding the comments in the first couple updates on Intel&#39;s attitude towards validation recently, <a href="https://news.ycombinator.com/item?id=16059635">another person claiming to be ex-Intel backs up the statements above</a>:</p> <blockquote> <p>As a former Intel employee this aligns closely with my experience. I didn&#39;t work in validation (actually joined as part of Altera) but velocity is an absolute buzzword and the senior management&#39;s approach to complex challenges is sheer panic. Slips in schedules are not tolerated at all - so problems in validation are an existential threat, your project can easily just be canned. Also, because of the size of the company the ways in which quality and completeness are &#39;acheived&#39; is hugely bureaucratic and rarely reflect true engineering fundamentals.</p> </blockquote> <h3 id="2024-update">2024 update</h3> <p>We&#39;re approaching a decade since I wrote this post and the serious CPU bugs keep coming. For example, this recent one was found by <a href="https://www.radgametools.com/oodleintel.htm">RAD tools</a>:</p> <blockquote> <p>Intel Processor Instability Causing Oodle Decompression Failures</p> <p>We believe that this is a hardware problem which affects primarily Intel 13900K and 14900K processors, less likely 13700, 14700 and other related processors as well. Only a small fraction of those processors will exhibit this behavior. The problem seems to be caused by a combination of BIOS settings and the high clock rates and power usage of these processors, leading to system instability and unpredictable behavior under heavy load ... Any programs which heavily use the processor on many threads may cause crashes or unpredictable behavior. There have been crashes seen in RealBench, CineBench, Prime95, Handbrake, Visual Studio, and more. This problem can also show up as a GPU error message, such as spurious &#34;out of video memory&#34; errors, even though it is caused by the CPU.</p> </blockquote> <p>One can argue that this is a configuration bug, but from the standpoint of a typical user, all what they observe is that their CPU is causing crashes. And, realistically, Intel knows that their CPUs are shipping into systems with these settings. The mitigation for this involves doing things like changing the following settings &#34;&#34;SVID behavior&#34; → &#34;Intel fail safe&#34;, &#34;Long duration power limit&#34; → reduce to 125W if set higher (&#34;Processor Base Power&#34; on ARK)&#34;, &#34;Short duration power limit&#34; → reduce to 253W if set higher (for 13900/14900 CPUs, other CPUs have other limits! &#34;Maximum Turbo Power&#34; on ARK)&#34;, etc.</p> <p>If they wanted their CPUs to not crash due to this issue, they could have and should have enforced these settings as well as some others. Instead, they left this up to the BIOS settings, and here we are.</p> <p>Historically, Intel was much more serious about verification, validation, and testing than AMD and we saw this in their output. At one point, when a lot of enthusiast sites were excited about AMD (in the K7 days), Google stopped using AMD and basically banned purchases of AMD CPUs because they were so buggy and had caused so many hard-to-debug problems. But, over time, the relative level of verification/validation/test effort Intel allocates has gone down and Intel seems to have nearly caught or maybe caught AMD in their rate of really serious bugs. Considering Intel&#39;s current market position, with very heavy pressure from AMD, ARM, and Nvidia, it seems unlikely that Intel will turn this around in the foreseeable future. Nvidia, historically, has been significantly buggier than AMD or Intel, so Intel still has quite a bit of room to run to become the most buggy major chip manufacturer. Considering that Nvidia is one of the biggest threats to Intel and how Intel responded to threats from other, then-buggier, manufacturers, it seems like we should expect an even higher rate of bad bugs in the coming decade.</p> <p>On the specific bug, there&#39;s tremendous pressure to operate more like a &#34;move fast and break things&#34; software company than a traditional, conservative, CPU manufacturer for multiple reasons. When you make a manufacture a CPU, how fast it will run ends up being somewhat random and there&#39;s no reliable way to tell how fast it will run other than testing it, so CPU companies run a set of tests on the CPU to see how fast it will go. This test time is actually fairly expensive, so there&#39;s a lot of work done to try to find the smallest set of tests possible that will correctly determine how fast the CPU can operate. One easy way to cut costs here is to just run fewer tests even if the smaller set of tests doesn&#39;t fully guarantee that the CPU can operate at the speed it&#39;s sold at.</p> <p>Another factor influencing this is that CPUs that are sold as nominally faster can sell for more, so there&#39;s also pressure to push the CPUs as close to their limits as possible. One way we can see that the margin here has, in general, decreased, is by looking at how overclockable CPUs are. People are often happy with their overclocked CPU if they run a few tests, like prime95, stresstest, etc., and their part doesn&#39;t crash, but this isn&#39;t nearly enough to determine if the CPU can really run everything a user could throw at it, but if you really try to seriously test a CPU (working at an Intel competitor, we would do this regularly), Intel and other CPU companies have really pushed the limit of how fast they claim their CPUs are relative to how fast they actually are, which sometimes results in CPUs that are sold that have been pushed beyond their capabilities.</p> <p>On overclocking, as Fabian Giesen of RAD notes,</p> <blockquote> <p>This stuff is not sanctioned and will count as overclocking if you try to RMA it but it&#39;s sold as a major feature of the platform and review sites test with it on.</p> </blockquote> <p>Daniel Gibson replied with</p> <blockquote> <p>hmm on my mainboard (ASUS ROG Strix B550-A Gaming -clearly gaming hardware, but middle price range) I had to explicitly enable the XMP/EXPO profile for the DDR4-RAM to run at full speed - which is DDR4-3200, officially supported by the CPU (Ryzen 5950X). Otherwise it ran at DDR4-2400 speed, I think? Or was it 2133? I forgot, at least significantly lower</p> </blockquote> <p>To which Fabian noted</p> <blockquote> <p>Correct. Fun fact: turning on EXPO technically voids your warranty ... t&#39;s great; both the CPU and the RAM list it as supported but it&#39;s officially not.</p> <p>One might call it a racket, if one were inclined to such incisive language.</p> </blockquote> <p>Intel didn&#39;t used to officially unofficially support this kind of thing. And, more generally, historically, CPU manufacturers were very hesitant to ship parts that had a non-negligible risk of crashes and data corruption when used as intended if they could avoid them, but more and more of these bugs keep happening. Some end up becoming quite public, like this, due to someone publishing a report about them like the RAD report above. And some get quietly reported to the CPU manufacturer by a huge company, often with some kind of NDA agreement, where the big company gets replacement CPUs and Intel or another manufacturer quietly ships firmware fixes to the issue. And it surely must be the case that some of these aren&#39;t really caught at all, unless you count the occasional data corruption or crash as being caught.</p> <h3 id="cpu-internals-series">CPU internals series</h3> <ul> <li><a href="https://danluu.com/new-cpu-features/">New CPU features since the 80s</a></li> <li><a href="https://danluu.com/branch-prediction/">A brief history of branch prediction</a></li> <li><a href="https://danluu.com/integer-overflow/">The cost of branches and integer overflow checking in real code</a></li> <li><a href="https://danluu.com/cpu-bugs/">CPU bugs</a></li> <li><a href="https://danluu.com/hardware-unforgiving/">Why CPU development is hard</a></li> <li><a href="https://danluu.com/why-hardware-development-is-hard/">Verilog sucks, part 1</a></li> <li><a href="https://danluu.com/pl-troll/">Verilog sucks, part 2</a></li> </ul> <p><small> Thanks to Leah Hanson, Jeff Ligouri, Derek Slager, Ralph Corderoy, Joe Wilder, Nate Martin, Hari Angepat, JonLuca De Caro, Jeff Fowler, and a number of anonymous tipsters for comments/corrections/discussion. </small></p>  </div></div>
        </section>
    </article>
</main>
</body>
</html>
