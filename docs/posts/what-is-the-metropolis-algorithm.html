<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>What is the Metropolis algorithm? | Rahul Vishwakarma Blog</title>
    <link rel="stylesheet" type="text/css" href="../styles.css" media="screen" />
</head>
<body>
<header>
    <nav>
        <a href="/index.html" aria-label="Go back to the homepage">← Back</a>
        <a href="https://jameshfisher.com/2024/04/18/metropolis-algorithm/" target="_blank" rel="noopener noreferrer">
            View Original
        </a>
    </nav>
</header>

<main>
    <article>
        <h1>What is the Metropolis algorithm?</h1>
        <section>
            
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous" onload="renderMath()"></script>
<script>
  function renderMath() {
    renderMathInElement(document.body,{
              delimiters: [
                  {left: "\\[", right: "\\]", display: true},
                  {left: "$", right: "$", display: false},
              ]
    });
  }
</script>
<p>We could estimate Bob’s lunch tomorrow
by counting the previous lunches you’ve seen him eating in the cafeteria:</p>
<table>
<thead>
<tr>
<th>Lunch</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<td>Apple</td>
<td>2</td>
</tr>
<tr>
<td>Banana</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>Now we want to simulate Bob’s future lunches.
Assume Bob randomly picks a lunch each morning,
with the relative proportions you’ve observed.
Then we can simulate Bob’s lunch with:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">Meal</span> <span class="token operator">=</span> <span class="token string">"Apple"</span> <span class="token operator">|</span> <span class="token string">"Banana"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Meal <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">5</span> <span class="token operator">?</span> <span class="token string">"Apple"</span> <span class="token operator">:</span> <span class="token string">"Banana"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>$\tfrac25$ of the samples will be <code>Apple</code>,
and $\tfrac35$ will be <code>Banana</code>.</p>
<p>The Metropolis algorithm gives a different way
to get samples with those correct proportions.
It looks like this:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">nextMeal</span><span class="token punctuation">(</span>currentMeal<span class="token operator">:</span> Meal<span class="token punctuation">)</span><span class="token operator">:</span> Meal <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMeal <span class="token operator">===</span> <span class="token string">"Apple"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Banana"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">"Apple"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">"Banana"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Chain</span> <span class="token punctuation">{</span>
  currentMeal<span class="token operator">:</span> Meal<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeal <span class="token operator">=</span> <span class="token string">"Apple"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Meal <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeal<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeal <span class="token operator">=</span> <span class="token function">nextMeal</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> current<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Yes:
this algorithm is more complicated and performs worse!
But the underlying technique can help us sample from more complex distributions.
So let’s see what it’s doing here, and why it works at all.</p>
<p>Instead of each <code>sample</code> call being independent,
the Metropolis algorithm initializes a <code>Chain</code>
which maintains a “current meal”.
Each call to <code>sample</code> sets the next meal.</p>
<p>Here’s one run of one chain:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Day </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> chain<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre><code>Day 0:  Apple
Day 1:  Banana
Day 2:  Apple
Day 3:  Banana
Day 4:  Banana
Day 5:  Apple
Day 6:  Banana
Day 7:  Banana
Day 8:  Apple
Day 9:  Banana</code></pre>
<p>Notice Bob’s first meal is always <code>Apple</code>.
And if Bob’s current meal is <code>Apple</code>,
the next meal is always <code>Banana</code>,
so Bob’s second meal is always <code>Banana</code>.
Here are two problems with the Metropolis algorithm:</p>
<ol>
<li>The first few samples are not in the correct distribution.</li>
<li>Samples are dependent on the previous samples.</li>
</ol>
<p>Let’s run $10{,}000$ chains,
and then log the distribution of apples on each day:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> chains<span class="token operator">:</span> Chain<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> chains<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> samples <span class="token operator">=</span> chains<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span> <span class="token operator">=></span> chain<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> numApples <span class="token operator">=</span> samples<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span> <span class="token operator">=></span> sample <span class="token operator">===</span> <span class="token string">"Apple"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Num apples on day </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> numApples<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre><code>Num apples on day 0: 0
Num apples on day 1: 6673
Num apples on day 2: 2202
Num apples on day 3: 5186
Num apples on day 4: 3184
Num apples on day 5: 4563
Num apples on day 6: 3600
Num apples on day 7: 4255
Num apples on day 8: 3846
Num apples on day 9: 4041</code></pre>
<p>By day $9$, approximately $4{,}000$ of the $10{,}000$ chains have apples.
This is the correct proportion of $\tfrac25$.
But the number bounces around before reaching this equilibrium.</p>
<p>This is called <em>convergence</em>.
To analyze this more mathematically,
we can instead simulate the <em>distribution</em> of chains for the current meal,
and calculate the distribution for the next meal:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">MealDist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">nextMealDist</span><span class="token punctuation">(</span>currentMealDist<span class="token operator">:</span> MealDist<span class="token punctuation">)</span><span class="token operator">:</span> MealDist <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>numApples<span class="token punctuation">,</span> numBananas<span class="token punctuation">]</span> <span class="token operator">=</span> currentMealDist<span class="token punctuation">;</span>

  <span class="token comment">// Consider those eating apples today. What will they eat tomorrow?</span>
  <span class="token keyword">let</span> a2a <span class="token operator">=</span> numApples <span class="token operator">*</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// None will eat apples.</span>
  <span class="token keyword">let</span> a2b <span class="token operator">=</span> numApples <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// All will eat bananas.</span>

  <span class="token comment">// Then consider those eating bananas today. What will they eat tomorrow?</span>
  <span class="token keyword">let</span> b2a <span class="token operator">=</span> numBananas <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Two-thirds will eat apples.</span>
  <span class="token keyword">let</span> b2b <span class="token operator">=</span> numBananas <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The rest will eat bananas.</span>

  <span class="token keyword">const</span> numApplesTomorrow <span class="token operator">=</span> a2a <span class="token operator">+</span> b2a<span class="token punctuation">;</span>
  <span class="token keyword">const</span> numBananasTomorrow <span class="token operator">=</span> a2b <span class="token operator">+</span> b2b<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>numApplesTomorrow<span class="token punctuation">,</span> numBananasTomorrow<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// To start, all 10,000 chains are eating apples.</span>
<span class="token keyword">let</span> currentMealDist<span class="token operator">:</span> MealDist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10_000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentMealDist <span class="token operator">=</span> <span class="token function">nextMealDist</span><span class="token punctuation">(</span>currentMealDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Num apples on day </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentMealDist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Again, we see that by day $9$,
around $\tfrac25$ of the chains are eating apples:</p>
<pre><code>Num apples on day 0: 0.000
Num apples on day 1: 6666.667
Num apples on day 2: 2222.222
Num apples on day 3: 5185.185
Num apples on day 4: 3209.877
Num apples on day 5: 4526.749
Num apples on day 6: 3648.834
Num apples on day 7: 4234.111
Num apples on day 8: 3843.926
Num apples on day 9: 4104.049</code></pre>
<p>Actually, we don’t need to start the distribution at <code>[10_000, 0]</code>.
We can just start with <code>[1, 0]</code>.
This is then a probability distribution,
because the sum of the two numbers is $1$.
Then the output is the probability distribution of the each meal:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> currentMealDist<span class="token operator">:</span> MealDist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentMealDist <span class="token operator">=</span> <span class="token function">nextMealDist</span><span class="token punctuation">(</span>currentMealDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Probability of apples on day </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentMealDist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre><code>Probability of apples on day 0: 0.000
Probability of apples on day 1: 0.667
Probability of apples on day 2: 0.222
Probability of apples on day 3: 0.519
Probability of apples on day 4: 0.321
Probability of apples on day 5: 0.453
Probability of apples on day 6: 0.365
Probability of apples on day 7: 0.423
Probability of apples on day 8: 0.384
Probability of apples on day 9: 0.410</code></pre>
<p>After 93 days, the probability of apples reaches a stable state,
at least in 64-bit floating-point.
And that stable state is the correct distribution:
$\tfrac25$ apple and $\tfrac35$ banana.</p>
<p>Because the first samples are not in the correct distribution,
it’s common to discard them.
This is called <em>burn-in</em>.</p>
<p>The precise claim of the Metroplis algorithm is:
the <em>correct</em> distribution is a <em>stable</em> distribution.
To prove this,
evaluate <code>nextMealDist([2/5, 3/5])</code>,
and you’ll see that it’s <code>[2/5, 3/5]</code>.
How many will eat <code>Apple</code> for the next meal?
None of the $\tfrac25$ currently eating apples will eat apples tomorrow.
Of the $\tfrac35$ currently eating bananas,
$\tfrac23$ will eat apples tomorrow.
for a total of $\tfrac35 \times \tfrac23 = \tfrac25$.
And so the probability of $\tfrac25$ is maintained.</p>
<p>The example algorithm above was hard-coded
to generate the stable state $\tfrac25$ and $\tfrac35$.
But time passes,
after which we’ve counted $3$ apple meals, and $6$ banana meals.
Let’s update the algorithm to work with any counts:</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// Our observed counts.</span>
<span class="token comment">// We want to generate more meals in this proportion.</span>
<span class="token keyword">const</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// Count of apples</span>
<span class="token keyword">const</span> <span class="token constant">B</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// Count of bananas</span>

<span class="token keyword">function</span> <span class="token function">nextMeal</span><span class="token punctuation">(</span>currentMeal<span class="token operator">:</span> Meal<span class="token punctuation">)</span><span class="token operator">:</span> Meal <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMeal <span class="token operator">===</span> <span class="token string">"Apple"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Banana"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">A</span> <span class="token operator">/</span> <span class="token constant">B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">"Apple"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">"Banana"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Let’s show that, for any counts $A$ and $B$,
this converges to the correct probability distribution,
$\tfrac{A}{A+B}$ and $\tfrac{B}{A+B}$.</p>
<p>
  \[
  \begin{aligned}
    \texttt{numApples} &= \tfrac{A}{A+B} \\
    \texttt{numBananas} &= \tfrac{B}{A+B} \\
    \\
    \texttt{a2a} &= 0 \\
    \texttt{b2a} &= \texttt{numBananas} \times \tfrac{A}{B} \\
                 &= \tfrac{B}{A+B} \times \tfrac{A}{B} \\
                 &= \tfrac{BA}{(A+B)B} \\
                 &= \tfrac{A}{A+B} \\
    \\
    \texttt{numApplesTomorrow} &= \texttt{a2a} + \texttt{b2a} \\
                               &= 0 + \tfrac{A}{A+B} \\
                               &= \tfrac{A}{A+B} \\
  \end{aligned}
  \]
</p>
<p>So far, we’ve only observed Bob eating <code>Apple</code> or <code>Banana</code>.
But then one day Bob’s in the cafeteria eating <code>Chips</code>!
We need to handle more states.
We can record our observed frequencies with a function <code>f</code>:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span>meal<span class="token operator">:</span> Meal<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    Apple<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    Banana<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
    Chips<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">[</span>meal<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The true Metropolis <code>sample</code> algorithm actually starts by <em>proposing</em> a new meal.
Then it decides whether to change to that meal,
or eat the current meal again.
Here’s a proposal function
that picks from possible meals with uniform probability:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">proposeMeal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Meal <span class="token punctuation">{</span>
  <span class="token keyword">const</span> meals<span class="token operator">:</span> Meal<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Apple"</span><span class="token punctuation">,</span> <span class="token string">"Banana"</span><span class="token punctuation">,</span> <span class="token string">"Chips"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> meals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Then the true <code>nextMeal</code> function looks like:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">nextMeal</span><span class="token punctuation">(</span>currentMeal<span class="token operator">:</span> Meal<span class="token punctuation">)</span><span class="token operator">:</span> Meal <span class="token punctuation">{</span>
  <span class="token keyword">const</span> proposedMeal <span class="token operator">=</span> <span class="token function">proposeMeal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> proposedMealFreq <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>proposedMeal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> currentMealFreq <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>currentMeal<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The key line!</span>
  <span class="token keyword">const</span> transitionProb <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>proposedMealFreq <span class="token operator">/</span> currentMealFreq<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> transitionProb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> proposedMeal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> currentMeal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>This works, but <em>why</em> does it work?
The key point in the proof is that,
for any two states $A$ and $B$ in the steady state,
the probability mass transferred from $A$ to $B$ is
the same as the probability mass transferred from $B$ to $A$.</p>
<p>Let’s prove that.
If we’re in steady state,
every state $S$ has mass proportional to $f(S)$.
For simplicity, just say the mass at $S$ is $f(S)$.
Without loss of generality, let’s assume $f(A) \leq f(B)$.</p>
<p>How much mass is transferred from state $A$ to $B$?
With our uniform proposal function,
$\tfrac1N^{th}$ of the mass at $A$ is proposed to move to $B$.
The probability of accepting this proposal is $\text{min}(1,\tfrac{f(B)}{f(A)})$.
Since $f(A) \leq f(B)$, this is $1$, i.e. the proposal is always accepted.
So the mass moving from $A$ to $B$ is $\tfrac{f(A)}{N}$.</p>
<p>How much mass is transferred from state $B$ to $A$?
Again, $\tfrac1N^{th}$ of the mass at $B$ is proposed to move to $A$.
The probability of accepting this proposal is $\text{min}(1,\tfrac{f(A)}{f(B)})$.
Since $f(A) \leq f(B)$, this is $\tfrac{f(A)}{f(B)}$.
So the mass moving from $B$ to $A$ is $\tfrac{f(B)}{N} \times \tfrac{f(A)}{f(B)} = \tfrac{f(A)}{N}$.</p>
<p>The same amount of mass, $\tfrac{f(A)}{N}$, is transferred from $A$ to $B$ as from $B$ to $A$.
This condition is called <em>detailed balance</em>,
and it implies that we are in a steady state.</p>
<p>The <code>proposeMeal</code> function above just picks a meal uniformly at random.
But we want to propose meals in proportion to their frequency.
The only requirement is that the proposal function
is <em>symmetric</em>: the probability of proposing $A$ from $B$
is the same as the probability of proposing $B$ from $A.
(Try to prove that this results in detailed balance.)</p>
<p>So far, we’ve been using discrete states.
But the Metropolis algorithm is most useful for continuous distributions.
Here’s a weird distribution over the real numbers:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">sinFreq</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> x <span class="token operator">&amp;&amp;</span> x <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We can sample from this distribution
using the Metropolis algorithm in its full generality:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Chain<span class="token operator">&lt;</span>State<span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token comment">// Initial state</span>
    <span class="token keyword">private</span> state<span class="token operator">:</span> State<span class="token punctuation">,</span>

    <span class="token comment">// Function to calculate the frequency of any state</span>
    <span class="token keyword">private</span> <span class="token function-variable function">f</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token operator">:</span> State<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">number</span><span class="token punctuation">,</span>

    <span class="token comment">// Function to propose a new state - must be symmetric</span>
    <span class="token keyword">private</span> <span class="token function-variable function">propose</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token operator">:</span> State<span class="token punctuation">)</span> <span class="token operator">=></span> State<span class="token punctuation">,</span>

    <span class="token comment">// Number of initial samples to discard</span>
    burnIn <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> burnIn<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> State <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">const</span> proposed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">propose</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> prob <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>proposed<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> next <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> prob <span class="token operator">?</span> proposed <span class="token operator">:</span> current<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token keyword">return</span> current<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">propose</span><span class="token punctuation">(</span>currentState<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> currentState <span class="token operator">+</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> sinFreq<span class="token punctuation">,</span> propose<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> numSamples <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> buckets<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSamples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sample <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> bucket <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>sample <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buckets<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>buckets<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> bucket <span class="token keyword">in</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  buckets<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span> <span class="token operator">/=</span> numSamples<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> bucket <span class="token keyword">in</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>buckets<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token operator">!</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Sure enough,
here’s that weird lumpy distribution:</p>
<pre><code>#
###
######
########
##########
#############
##############
################
##################
####################
######################
#######################
########################
########################
#########################
#########################
#########################
#########################
########################
#######################
######################
#####################
###################
##################
################
##############
############
#########
#######
####
##

##
#####
#######
#########
###########
##############
###############
#################
###################
#####################
######################
#######################
########################
########################
#########################
########################
########################
########################
#######################
######################
#####################
###################
#################
################
##############
############
##########
#######
#####
###</code></pre>
        </section>
    </article>
</main>
</body>
</html>
